<!DOCTYPE html>
<html>
<head>
    <title>Flashcard Cá Nhân</title>
    <style>
        /* --- Base Styles & Variables --- */
        :root {
            --bg-color: #f8f9fa; /* Nền sáng hơn một chút */
            --text-color: #212529; /* Text tối hơn một chút */
            --card-bg: #ffffff;
            --border-color: #dee2e6; /* Border nhạt hơn */
            --input-bg: #ffffff;
            --input-text: #495057;
            --input-border: #ced4da;
            --input-focus-border: #86b7fe;
            --input-focus-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);

            --primary-btn-bg: #0d6efd;
            --primary-btn-hover-bg: #0b5ed7;
            --primary-btn-text: #ffffff;

            --secondary-btn-bg: #6c757d;
            --secondary-btn-hover-bg: #5c636a;
            --secondary-btn-text: #ffffff;

            --danger-btn-bg: #dc3545;
            --danger-btn-hover-bg: #bb2d3b;
            --danger-btn-text: #ffffff;

            --warning-btn-bg: #ffc107;
            --warning-btn-hover-bg: #ffca2c;
            --warning-btn-text: #000;

            --success-btn-bg: #198754;
            --success-btn-hover-bg: #157347;
            --success-btn-text: #ffffff;

            --shadow-sm: 0 .125rem .25rem rgba(0, 0, 0, .075);
            --shadow-md: 0 .5rem 1rem rgba(0, 0, 0, .15);
        }

        .dark-mode {
            --bg-color: #212529;
            --text-color: #dee2e6;
            --card-bg: #343a40;
            --border-color: #495057;
            --input-bg: #343a40;
            --input-text: #dee2e6;
            --input-border: #6c757d;
            --input-focus-border: #5b99e4;
            --input-focus-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.35);

            --primary-btn-bg: #0d6efd;
            --primary-btn-hover-bg: #3b82f6;
            --secondary-btn-bg: #6c757d;
            --secondary-btn-hover-bg: #858c93;
            --danger-btn-bg: #dc3545;
            --danger-btn-hover-bg: #e45d6a;
            --warning-btn-bg: #ffc107;
            --warning-btn-hover-bg: #ffd041;
            --success-btn-bg: #198754;
            --success-btn-hover-bg: #20a768;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 700px; /* Tăng chiều rộng tối đa một chút */
            margin: 30px auto; /* Tăng margin trên dưới */
            padding: 20px; /* Tăng padding */
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            line-height: 1.6; /* Cải thiện khả năng đọc */
        }

        h1 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--text-color);
        }

        /* --- Theme Toggle Switch --- */
        .theme-toggle {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            margin-bottom: 25px;
            gap: 10px;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #87CEEB; /* Màu trời xanh ban ngày */
            transition: background-color .4s;
            overflow: hidden;
        }

        /* Style cho nút tròn di chuyển mới (.handle) */
        .slider .handle {
            position: absolute;
            content: "";
            height: 22px; /* Kích thước nút tròn */
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: #FFD700; /* Màu vàng mặt trời (light) */
            box-shadow: 0 0 5px rgba(255, 215, 0, 0.7); /* Hào quang nhẹ */
            transition: transform .4s, background-color .4s, box-shadow .4s;
            border-radius: 50%; /* Bo tròn nút */
            z-index: 2; /* Đảm bảo handle trên stars */
            display: flex; /* Để căn giữa icon bên trong */
            justify-content: center; /* Căn ngang icon */
            align-items: center; /* Căn dọc icon */
            overflow: hidden; /* Ẩn phần icon thừa nếu cần */
        }


        input:checked + .slider {
            background-color: #2c3e50; /* Màu nền trời đêm */
        }

        /* Di chuyển .handle khi checked */
        input:checked + .slider .handle {
            transform: translateX(30px); /* Khoảng cách di chuyển nút tròn */
            background-color: #f1c40f; /* Màu vàng nhạt hơn cho mặt trăng (dark) */
            box-shadow: 0 0 8px rgba(241, 196, 15, 0.6); /* Hào quang mặt trăng */
        }

        /* Bo tròn slider ngoài */
        .slider.round {
            border-radius: 30px;
        }

        /* --- Icons (Bên trong .handle) --- */
        .handle .icon {
            position: absolute; /* Vẫn là absolute để có thể chồng lên nhau */
            font-size: 16px;
            transition: opacity 0.4s ease; /* Chỉ cần transition opacity */
        }

        .handle .sun {
            opacity: 1; /* Hiện ở chế độ sáng (mặc định) */
            color: #f39c12;
            animation: spin 10s linear infinite; /* Giữ animation quay */
        }

        .handle .moon {
            opacity: 0; /* Ẩn ở chế độ sáng */
            color: #f1c40f;
            /* Không cần transform translateX nữa */
        }

        /* Khi switch được check (dark mode) */
        input:checked + .slider .handle .sun {
            opacity: 0; /* Ẩn mặt trời */
            animation-play-state: paused; /* Dừng quay mặt trời */
        }

        input:checked + .slider .handle .moon {
            opacity: 1; /* Hiện mặt trăng */
        }

        /* --- Stars (Không đổi) --- */
        .slider .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.4s ease 0.2s;
            pointer-events: none;
            z-index: 0; /* Nằm dưới cùng */
        }

        .slider .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 0 3px white;
            animation: twinkle 1.5s infinite alternate ease-in-out;
        }

        .slider .star:nth-child(1) { top: 20%; left: 60%; animation-delay: 0.1s; }
        .slider .star:nth-child(2) { top: 40%; left: 80%; animation-delay: 0.5s; }
        .slider .star:nth-child(3) { top: 70%; left: 75%; animation-delay: 0.9s; }
        .slider .star:nth-child(4) { top: 50%; left: 90%; animation-delay: 0.3s; }

        input:checked + .slider .stars {
            opacity: 1;
        }

        /* Keyframes cho animation (Không đổi) */
        @keyframes twinkle {
            from { opacity: 0.2; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* Sửa lại keyframes spin cho phù hợp khi icon không cần translateY */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        /* --- End Theme Toggle Switch --- */



        /* Rounded sliders */
        .slider.round {
            border-radius: 26px;
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* --- Input Fields & Select --- */
        input[type="text"], select {
            display: block; /* Hiển thị trên một dòng riêng */
            width: 100%; /* Chiếm toàn bộ chiều rộng có sẵn */
            padding: 10px 12px; /* Tăng padding */
            margin-bottom: 10px; /* Khoảng cách dưới */
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--input-text);
            border: 1px solid var(--input-border);
            border-radius: 6px; /* Bo góc nhiều hơn */
            box-sizing: border-box; /* Quan trọng để padding không làm tăng kích thước */
            transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
        }

        input[type="text"]:focus, select:focus {
            border-color: var(--input-focus-border);
            outline: 0;
            box-shadow: var(--input-focus-shadow);
        }

        select {
            cursor: pointer;
        }

        /* --- Buttons --- */
        button {
            padding: 10px 18px; /* Tăng padding */
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--button-text); /* Sẽ bị ghi đè bởi class cụ thể */
            background-color: var(--secondary-btn-bg); /* Màu mặc định */
            border: none;
            border-radius: 6px; /* Đồng bộ bo góc */
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            margin-right: 5px; /* Khoảng cách nhỏ giữa các nút */
            margin-bottom: 5px; /* Khoảng cách khi nút xuống dòng */
        }

        button:hover {
            background-color: var(--secondary-btn-hover-bg); /* Hover mặc định */
            /* transform: translateY(-1px); /* Hiệu ứng nhấc lên nhẹ */
        }

        button:active {
            transform: scale(0.98); /* Hiệu ứng nhấn xuống */
        }

        /* Button Specific Colors */
        .group-management button:first-of-type, /* Nút Tạo nhóm */
        .add-card button, /* Nút Thêm thẻ */
        #quiz-check-btn { /* Nút Kiểm tra/Tiếp theo/Thử lại */
            background-color: var(--primary-btn-bg);
            color: var(--primary-btn-text);
        }
        .group-management button:first-of-type:hover,
        .add-card button:hover,
        #quiz-check-btn:hover {
            background-color: var(--primary-btn-hover-bg);
        }

        .delete-group-btn,
        .flashcard button { /* Nút xóa thẻ */
            background-color: var(--danger-btn-bg);
            color: var(--danger-btn-text);
            padding: 6px 12px; /* Nút xóa nhỏ hơn */
            font-size: 0.85rem;
        }
        .delete-group-btn:hover,
        .flashcard button:hover {
            background-color: var(--danger-btn-hover-bg);
        }

        .pause-button {
            background-color: var(--warning-btn-bg);
            color: var(--warning-btn-text);
        }
        .pause-button:hover {
            background-color: var(--warning-btn-hover-bg);
        }

        .resume-button,
        #start-quiz-btn { /* Nút Bắt đầu/Tiếp tục Quiz */
            background-color: var(--success-btn-bg);
            color: var(--success-btn-text);
        }
        .resume-button:hover,
        #start-quiz-btn:hover {
            background-color: var(--success-btn-hover-bg);
        }

        /* --- Layout Sections --- */
        .group-management {
            margin-bottom: 30px; /* Tăng khoảng cách */
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg); /* Nền nhẹ */
            box-shadow: var(--shadow-sm);
            display: flex;
            flex-wrap: wrap; /* Cho phép xuống dòng */
            gap: 10px; /* Khoảng cách giữa các item */
            align-items: center; /* Căn giữa các item */
        }
        /* Điều chỉnh input và select trong group management */
        .group-management input[type="text"],
        .group-management select {
            flex: 1 1 180px; /* Cho phép co giãn, cơ sở 180px */
            margin-bottom: 0; /* Bỏ margin bottom vì đã có gap */
            width: auto; /* Để flex quản lý */
        }
        .group-management button {
            flex-shrink: 0; /* Không co lại */
            margin-bottom: 0;
        }

        .add-card {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--card-bg);
            box-shadow: var(--shadow-sm);
        }
        .add-card input[type="text"] {
            margin-bottom: 15px; /* Khoảng cách giữa 2 input */
        }
        .add-card button {
            width: 100%; /* Nút thêm thẻ chiếm hết chiều rộng */
        }

        #quiz-controls {
            text-align: center; /* Căn giữa nút Start/Resume */
            margin-bottom: 20px;
        }
        #quiz-controls button {
            padding: 12px 25px; /* Nút to hơn */
            font-size: 1.1rem;
        }

        /* --- Flashcard Styling --- */
        #flashcards {
            margin-top: 20px;
        }

        .flashcard {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 15px 20px; /* Tăng padding */
            margin-bottom: 15px; /* Khoảng cách giữa các thẻ */
            border-radius: 8px; /* Đồng bộ bo góc */
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
            word-wrap: break-word;
            position: relative; /* Để định vị nút xóa */
        }

        .flashcard:hover {
            box-shadow: var(--shadow-md);
            /* transform: translateY(-2px); */ /* Hiệu ứng nổi lên nhẹ khi hover */
        }

        .flashcard strong {
            margin-right: 5px;
            color: var(--text-color);
        }

        .flashcard input[type="text"] {
            width: calc(100% - 30px); /* Trừ đi padding của thẻ */
            margin: 5px 0 10px 0; /* Khoảng cách trên dưới */
            padding: 6px 8px; /* Padding nhỏ hơn cho input trong thẻ */
            font-size: 0.95rem;
            background-color: var(--input-bg); /* Đảm bảo nền input đúng */
            color: var(--input-text);
            border: 1px solid var(--input-border);
            border-radius: 4px;
        }
        .flashcard input[type="text"]:focus {
            box-shadow: none; /* Bỏ shadow khi focus input trong thẻ */
            border-color: var(--input-focus-border);
        }

        .flashcard .answer-display {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color); /* Phân cách câu trả lời */
        }

        .flashcard button { /* Nút xóa thẻ */
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0.7; /* Hơi mờ đi */
            transition: opacity 0.2s ease;
        }
        .flashcard:hover button {
            opacity: 1; /* Hiện rõ khi hover thẻ */
        }

        .hidden {
            display: none !important; /* Dùng !important để đảm bảo ghi đè */
        }

        /* --- Quiz Container --- */
        #quiz-container {
            margin-top: 30px;
            padding: 25px; /* Tăng padding */
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md); /* Shadow rõ hơn cho quiz */
        }

        #quiz-question {
            font-size: 1.3rem; /* Câu hỏi to hơn */
            font-weight: 500;
            margin-bottom: 20px;
        }

        #quiz-answer {
            width: calc(100% - 24px); /* Chiếm gần hết chiều rộng */
            padding: 10px 12px;
            margin: 15px 0;
            background-color: var(--input-bg);
            color: var(--input-text);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            font-size: 1rem;
        }
        #quiz-answer:focus {
            border-color: var(--input-focus-border);
            outline: 0;
            box-shadow: var(--input-focus-shadow);
        }

        #quiz-feedback {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            min-height: 50px; /* Chiều cao tối thiểu để tránh nhảy layout */
            transition: background-color 0.3s ease; /* Transition cho feedback */
        }

        #quiz-score {
            margin-top: 15px;
            font-weight: bold;
            text-align: right;
        }

        /* Quiz Feedback Colors */
        .correct {
            color: var(--success-btn-bg); /* Màu xanh lá */
            font-weight: bold;
        }

        .wrong {
            color: var(--danger-btn-bg); /* Màu đỏ */
            font-weight: bold;
        }
        #quiz-feedback .wrong + div { /* Các dòng dưới chữ "Sai rồi" */
            margin-top: 8px;
            font-size: 0.95rem;
        }
        #quiz-feedback .wrong + div span[style*="color: red"] { /* Từ đúng màu đỏ */
            background-color: rgba(220, 53, 69, 0.1); /* Nền đỏ nhạt */
            padding: 1px 3px;
            border-radius: 3px;
        }
        #quiz-feedback .wrong + div s[style*="color: grey"] { /* Từ sai gạch ngang */
            opacity: 0.7;
        }


        /* --- Animations (Giữ nguyên hoặc tinh chỉnh nếu cần) --- */
        @keyframes correct-pulse {
            0% { transform: scale(1); background-color: rgba(25, 135, 84, 0.1); } /* Nền xanh nhạt */
            50% { transform: scale(1.02); background-color: rgba(25, 135, 84, 0.2); }
            100% { transform: scale(1); background-color: rgba(25, 135, 84, 0.1); }
        }

        @keyframes wrong-shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }

        .animate-correct {
            animation: correct-pulse 0.6s ease-in-out;
            background-color: rgba(25, 135, 84, 0.1); /* Nền xanh nhạt khi đúng */
        }

        .animate-wrong {
            /* Animation sẽ áp dụng cho span .wrong bên trong #quiz-feedback */
            animation: wrong-shake 0.5s ease-in-out;
            /* Nền đỏ cho toàn bộ feedback khi sai */
            background-color: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
        }

        /* Loại bỏ animation cũ trên #quiz-feedback trực tiếp */
        /* #quiz-feedback.animate-wrong { ... } */

        /* Áp dụng animation rung lắc cho span .wrong */
        #quiz-feedback span.wrong.animate-wrong {
            display: inline-block; /* Cần thiết để transform hoạt động */
            animation: wrong-shake 0.5s ease-in-out;
        }

        /* --- Responsive (Ví dụ đơn giản) --- */
        @media (max-width: 600px) {
            body {
                padding: 15px;
                margin: 15px auto;
            }
            .group-management {
                flex-direction: column; /* Xếp chồng lên nhau trên màn hình nhỏ */
                align-items: stretch; /* Kéo dài các item */
            }
            .group-management input[type="text"],
            .group-management select,
            .group-management button {
                width: 100%; /* Chiếm hết chiều rộng */
                margin-right: 0;
            }
            h1 {
                font-size: 1.8rem;
            }
            #quiz-answer {
                width: calc(100% - 20px); /* Điều chỉnh lại */
            }
        }

    </style>
</head>
<body>
    <!-- Toggle theme switch -->
    <div class="theme-toggle">
        <span>Chế độ tối</span>
        <label class="switch">
            <input type="checkbox" id="theme-switch" onchange="toggleTheme()">
            <span class="slider round">
                <!-- Nút tròn di chuyển (thay thế cho :before) -->
                <span class="handle">
                    <span class="icon sun">☀️</span>
                    <span class="icon moon">🌙</span>
                </span>
                <!-- Các ngôi sao vẫn nằm trong slider -->
                <span class="stars">
                    <span class="star"></span>
                    <span class="star"></span>
                    <span class="star"></span>
                    <span class="star"></span>
                </span>
            </span>
        </label>
    </div>

    
    <div class="group-management">
        <input type="text" id="new-group" placeholder="Tên nhóm mới">
        <button onclick="createGroup()">Tạo nhóm</button>
        <select id="group-select" onchange="changeGroup(this.value)"></select>
        <button class="delete-group-btn" onclick="deleteCurrentGroup()">Xóa nhóm</button>
        <input type="text" id="rename-group" placeholder="Tên mới...">
        <button onclick="renameGroup()">Đổi tên nhóm</button>

    </div>

    <h1>Flashcard của bạn</h1>
    
    <div class="add-card">
        <input type="text" id="question" placeholder="Câu hỏi...">
        <input type="text" id="answer" placeholder="Câu trả lời...">
        <button onclick="addCard()">Thêm thẻ</button>
    </div>

    <!-- Nút Bắt đầu/Tiếp tục Quiz -->
    <div id="quiz-controls">
        <button class="quiz-button" id="start-quiz-btn" onclick="startQuiz()">Bắt đầu Quiz</button>
    </div>

    <div id="quiz-container" class="hidden">
        <div id="quiz-question"></div>
        <input type="text" id="quiz-answer" placeholder="Nhập câu trả lời...">
        <button id="quiz-check-btn" onclick="checkAnswer()">Kiểm tra</button>
        <button id="quiz-pause-btn" class="pause-button" onclick="pauseQuiz()">Tạm dừng</button>
        <div id="quiz-feedback"></div>
        <div id="quiz-score"></div>
    </div>

    <div id="flashcards"></div>

    <script>
        // --- IndexedDB Helper Functions ---
const DB_NAME = 'FlashcardAppDB';
const DB_VERSION = 1; // Tăng version nếu thay đổi cấu trúc (thêm/xóa object store/index)
const GROUP_STORE_NAME = 'groups';
let db; // Biến lưu trữ đối tượng database

// Mở (hoặc tạo) cơ sở dữ liệu
    function openDB() {
        return new Promise((resolve, reject) => {
            if (db) { // Nếu đã mở, trả về ngay
                return resolve(db);
            }
            console.log(`Mở ${DB_NAME} version ${DB_VERSION}`);
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onerror = (event) => {
                console.error("Lỗi khi mở IndexedDB:", event.target.error);
                reject("Lỗi khi mở DB");
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log("IndexedDB đã mở thành công.");
                resolve(db);
            };

        // Chỉ chạy khi tạo DB lần đầu hoặc nâng cấp version
            request.onupgradeneeded = (event) => {
                console.log("Chạy onupgradeneeded...");
                const tempDb = event.target.result;
                if (!tempDb.objectStoreNames.contains(GROUP_STORE_NAME)) {
                    console.log(`Tạo object store: ${GROUP_STORE_NAME}`);
                    tempDb.createObjectStore(GROUP_STORE_NAME, { keyPath: 'id' });
                }
            };
        });
    }

    async function getAllGroupsDB() {
        const dbInstance = await openDB();
        return new Promise((resolve, reject) => {
            const transaction = dbInstance.transaction(GROUP_STORE_NAME, 'readonly');
            const store = transaction.objectStore(GROUP_STORE_NAME);
            const request = store.getAll(); // Lấy tất cả object

            request.onerror = (event) => {
                console.error("Lỗi khi lấy tất cả nhóm:", event.target.error);
                reject("Lỗi đọc dữ liệu nhóm");
            };

            request.onsuccess = (event) => {
                resolve(event.target.result || []); // Trả về mảng kết quả hoặc mảng rỗng
            };
        });
    }

    async function saveGroupDB(group) {
        const dbInstance = await openDB();
        return new Promise((resolve, reject) => {
            const transaction = dbInstance.transaction(GROUP_STORE_NAME, 'readwrite');
            const store = transaction.objectStore(GROUP_STORE_NAME);
            const request = store.put(group); // put sẽ thêm mới hoặc cập nhật nếu key đã tồn tại

            request.onerror = (event) => {
                console.error("Lỗi khi lưu nhóm:", event.target.error, 'Data:', group); // Thêm log data
                reject("Lỗi lưu dữ liệu nhóm");
            };

            request.onsuccess = (event) => {
                console.log('saveGroupDB thành công! Key:', event.target.result, 'Data:', group); // Thêm log data
                resolve(event.target.result);
            };
        });
    }

    async function deleteGroupDB(groupId) {
        const dbInstance = await openDB();
        return new Promise((resolve, reject) => {
            const transaction = dbInstance.transaction(GROUP_STORE_NAME, 'readwrite');
            const store = transaction.objectStore(GROUP_STORE_NAME);
            const request = store.delete(groupId);

            request.onerror = (event) => {
                console.error("Lỗi khi xóa nhóm:", event.target.error);
                reject("Lỗi xóa dữ liệu nhóm");
            };

            request.onsuccess = (event) => {
                console.log(`Đã xóa nhóm ID: ${groupId}`);
                resolve();
            };
        });
    }

// Lấy một nhóm cụ thể bằng ID (hữu ích cho việc cập nhật thẻ)
    async function getGroupByIdDB(groupId) {
        const dbInstance = await openDB();
        return new Promise((resolve, reject) => {
            const transaction = dbInstance.transaction(GROUP_STORE_NAME, 'readonly');
            const store = transaction.objectStore(GROUP_STORE_NAME);
            const request = store.get(groupId);
        
            request.onerror = (event) => {
                console.error(`Lỗi khi lấy nhóm ID ${groupId}:`, event.target.error);
                reject("Lỗi đọc dữ liệu nhóm");
            };

            request.onsuccess = (event) => {
                resolve(event.target.result); // Trả về group object hoặc undefined nếu không tìm thấy
            };
        });
    }
        
        let groups = [];
        let currentGroupId = 'default';
        let quizMode = false;
        let quizCheckButton = null; // Tham chiếu đến nút Kiểm tra/Tiếp theo/Thử lại
        let quizPauseButton = null; // Tham chiếu đến nút Tạm dừng
        let quizAnswerInput = null; // Tham chiếu đến ô nhập câu trả lời quiz
        let quizFeedback = null;    // Tham chiếu đến phần phản hồi
        let quizScoreDisplay = null; // Tham chiếu đến hiển thị điểm
        let quizQuestionDisplay = null; // Tham chiếu đến hiển thị câu hỏi

        // --- Biến cho logic quiz mới ---
        let quizSessionCards = []; // Mảng thẻ dùng trong phiên quiz hiện tại
        let currentQuizIndex = 0;  // Chỉ số thẻ hiện tại trong quizSessionCards
        let masteredCount = 0;     // Số thẻ đã thuộc (đúng 2 lần liên tiếp)

        // Hàm chuyển đổi giao diện
        function toggleTheme() {
            const isDark = document.getElementById('theme-switch').checked;
            if (isDark) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
        }

        // Khởi tạo danh sách nhóm
        function initGroups() {
            const select = document.getElementById('group-select');
            select.innerHTML = groups.map(group => `
                <option value="${group.id}" ${group.id === currentGroupId ? 'selected' : ''}>
                    ${group.name} (${group.cards.length} thẻ)
                </option>
            `).join('');
            // Sau khi cập nhật select, kiểm tra lại quiz đang tạm dừng
            checkPausedQuiz();
        }

        // Hàm tô màu sự khác biệt (giữ nguyên)
        function highlightDiff(wrong, correct) {
            // ... (code hàm highlightDiff không đổi) ...
             const wrongWords = wrong.trim().split(/\s+/);
            const correctWords = correct.trim().split(/\s+/);
            let result = [];

            const maxLength = Math.max(wrongWords.length, correctWords.length);
            for (let i = 0; i < maxLength; i++) {
                const wrongWord = wrongWords[i] || '';
                const correctWord = correctWords[i] || '';
                if (wrongWord.toLowerCase() === correctWord.toLowerCase()) { // So sánh không phân biệt hoa thường
                    result.push(correctWord);
                } else {
                    // Hiển thị từ đúng màu đỏ, từ sai gạch ngang (tùy chọn)
                     result.push(`<span style="color: red; font-weight: bold;">${correctWord || '[thiếu]'}</span>` + (wrongWord ? ` <s style="color: grey;">${wrongWord}</s>` : ''));
                    // Hoặc chỉ hiển thị từ đúng:
                    // result.push(`<span style="color: red; font-weight: bold">${correctWord || '[thiếu]'}</span>`);
                }
            }
            return result.join(' ');
        }

        // Tạo nhóm mới
        async function createGroup() {
            const groupName = document.getElementById('new-group').value.trim();
            if (!groupName) return;
            const newGroupId = Date.now().toString(); // Tạo ID duy nhất
            const newGroup = { id: newGroupId, name: groupName, cards: [] };
        
            try {
                await saveGroupDB(newGroup); // Lưu vào DB
                groups.push(newGroup); // Thêm vào mảng trong bộ nhớ
                initGroups(); // Cập nhật UI
                document.getElementById('new-group').value = '';
                changeGroup(newGroup.id); // Chuyển sang nhóm mới (hàm này cần đảm bảo xử lý async nếu cần)
            } catch (error) {
                alert("Lỗi khi tạo nhóm mới.");
                console.error("Lỗi createGroup:", error);
            }
        }

        // Thay đổi nhóm hiện tại
        function changeGroup(groupId) {
            // Nếu đang trong quiz, không cho đổi nhóm (hoặc hỏi xác nhận hủy quiz)
            if (quizMode) {
                if (!confirm("Bạn đang trong quiz. Chuyển nhóm sẽ hủy tiến trình quiz hiện tại. Bạn có chắc chắn?")) {
                    // Đặt lại select về giá trị cũ
                    document.getElementById('group-select').value = currentGroupId;
                    return;
                }
                // Nếu xác nhận, kết thúc quiz hiện tại mà không lưu
                forceEndQuiz();
            }
            currentGroupId = groupId;
            document.getElementById('group-select').value = currentGroupId; // Đảm bảo select được cập nhật
            renderCards();
            checkPausedQuiz(); // Kiểm tra lại nút Resume cho nhóm mới
        }

        // Xóa nhóm hiện tại
        async function deleteCurrentGroup() {
            if (currentGroupId === 'default') {
                alert("Không thể xóa nhóm mặc định!");
                return;
            }
            // Kiểm tra quiz đang tạm dừng (vẫn dùng localStorage)
            const savedProgress = JSON.parse(localStorage.getItem('quizProgress') || 'null');
            if (savedProgress && savedProgress.groupId === currentGroupId) {
                if (!confirm("Nhóm này có tiến trình quiz đang tạm dừng. Xóa nhóm cũng sẽ xóa tiến trình này. Bạn có chắc chắn?")) {
                    return;
                }
                localStorage.removeItem('quizProgress');
                checkPausedQuiz();
            }
        
            const groupToDelete = groups.find(g => g.id === currentGroupId);
            if (!groupToDelete) return; // Không tìm thấy nhóm?
        
            if (confirm(`Xóa nhóm "${groupToDelete.name}" và toàn bộ thẻ bên trong?`)) {
                try {
                    await deleteGroupDB(currentGroupId); // Xóa khỏi DB
                    groups = groups.filter(g => g.id !== currentGroupId); // Xóa khỏi mảng trong bộ nhớ
                    currentGroupId = groups.find(g => g.id === 'default')?.id || groups[0]?.id || null; // Chuyển về mặc định hoặc nhóm đầu tiên
        
                    if (!currentGroupId && groups.length === 0) {
                         // Nếu không còn nhóm nào, tạo lại nhóm mặc định
                         console.log("Không còn nhóm nào, tạo lại nhóm mặc định.");
                         const defaultGroup = { id: 'default', name: 'Mặc định', cards: [] };
                         await saveGroupDB(defaultGroup);
                         groups.push(defaultGroup);
                         currentGroupId = 'default';
                    } else if (!currentGroupId) {
                        // Trường hợp lỗi không mong muốn
                        console.error("Không thể xác định nhóm hiện tại sau khi xóa.");
                        alert("Đã xảy ra lỗi sau khi xóa nhóm.");
                        currentGroupId = 'default'; // Fallback an toàn
                    }
        
        
                    initGroups(); // Cập nhật select box
                    renderCards(); // Render lại thẻ
                } catch (error) {
                    alert("Lỗi khi xóa nhóm.");
                    console.error("Lỗi deleteCurrentGroup:", error);
                }
            }
        }

        // Đổi tên nhóm
        async function renameGroup() {
            const newName = document.getElementById('rename-group').value.trim();
            if (!newName) {
                alert("Vui lòng nhập tên mới cho nhóm.");
                return;
            }
            const currentGroup = groups.find(g => g.id === currentGroupId);
            if (!currentGroup) return;
        
            const originalName = currentGroup.name; // Lưu tên cũ phòng lỗi
            currentGroup.name = newName; // Cập nhật tên trong mảng bộ nhớ
        
            try {
                await saveGroupDB(currentGroup); // Lưu thay đổi vào DB
                initGroups(); // Cập nhật tên trong select
                document.getElementById('rename-group').value = '';
                // Cập nhật nút Resume nếu cần (logic này không đổi vì dùng localStorage)
                checkPausedQuiz();
            } catch (error) {
                alert("Lỗi khi đổi tên nhóm.");
                console.error("Lỗi renameGroup:", error);
                currentGroup.name = originalName; // Hoàn tác thay đổi trong bộ nhớ nếu lưu DB lỗi
                initGroups(); // Cập nhật lại UI về trạng thái cũ
            }
        }

        // --- Logic Quiz Mới ---

        function startQuiz(resume = false) {
            if (!resume) {
                 // Nếu bắt đầu quiz mới, xóa tiến trình cũ nếu có
                 localStorage.removeItem('quizProgress');
                 checkPausedQuiz(); // Ẩn nút Resume nếu có

                const currentGroup = groups.find(g => g.id === currentGroupId);
                if (!currentGroup || currentGroup.cards.length === 0) {
                    alert("Vui lòng thêm thẻ vào nhóm này trước!");
                    return;
                }

                // Tạo mảng thẻ cho phiên quiz
                quizSessionCards = currentGroup.cards.map(card => ({
                    ...card, // Sao chép thuộc tính gốc (question, answer)
                    correctStreak: 0,
                    isMastered: false
                }));

                // Reset trạng thái
                currentQuizIndex = 0;
                masteredCount = 0;

            } else {
                // Logic resume đã xử lý việc khôi phục state trong resumeQuiz()
                 if (quizSessionCards.length === 0) {
                     console.error("Lỗi: Không thể tiếp tục quiz, không có dữ liệu thẻ.");
                     alert("Đã xảy ra lỗi khi tiếp tục quiz. Vui lòng bắt đầu lại.");
                     forceEndQuiz();
                     return;
                 }
            }


            if (quizSessionCards.length === 0) {
                 alert("Nhóm này không có thẻ nào để học!");
                 return;
            }

            console.log('Bắt đầu quiz. Nhóm hiện tại:', currentGroupId);
            console.log('Dữ liệu thẻ cho quiz (quizSessionCards):', JSON.stringify(quizSessionCards));

            quizMode = true;
            document.getElementById('quiz-container').classList.remove('hidden');
            document.getElementById('flashcards').classList.add('hidden');
            document.querySelector('.add-card').classList.add('hidden');
            document.getElementById('quiz-controls').classList.add('hidden'); // Ẩn nút Start/Resume

            updateScoreDisplay();
            showNextQuestion();
        }

        function showNextQuestion() {
            // Kiểm tra xem tất cả đã master chưa
            if (masteredCount >= quizSessionCards.length) {
                endQuiz();
                return;
            }

            // Tìm thẻ chưa master tiếp theo
            let attempts = 0; // Ngăn vòng lặp vô hạn nếu có lỗi logic
            let foundIndex = -1;

            // Bắt đầu tìm từ vị trí sau vị trí hiện tại
            let searchIndex = (currentQuizIndex + 1) % quizSessionCards.length;

            while (attempts < quizSessionCards.length) {
                 if (!quizSessionCards[searchIndex].isMastered) {
                     foundIndex = searchIndex;
                     break;
                 }
                 searchIndex = (searchIndex + 1) % quizSessionCards.length;
                 attempts++;
            }

             // Nếu không tìm thấy (trường hợp này không nên xảy ra nếu masteredCount < length)
             if (foundIndex === -1) {
                 // Có thể tất cả đã master, kiểm tra lại
                 if (quizSessionCards.every(card => card.isMastered)) {
                     endQuiz();
                     return;
                 } else {
                     // Lỗi logic không mong muốn, thử tìm từ đầu
                     console.warn("Không tìm thấy thẻ chưa master tiếp theo, thử tìm lại từ đầu.");
                     foundIndex = quizSessionCards.findIndex(card => !card.isMastered);
                     if (foundIndex === -1) {
                         console.error("Lỗi nghiêm trọng: Không tìm thấy thẻ chưa master nào dù masteredCount chưa đủ.");
                         alert("Đã xảy ra lỗi trong quá trình quiz. Quiz sẽ kết thúc.");
                         forceEndQuiz();
                         return;
                     }
                 }
             }


            currentQuizIndex = foundIndex;
            const currentCard = quizSessionCards[currentQuizIndex];

            console.log('Hiển thị câu hỏi tiếp theo. Index:', currentQuizIndex);
            console.log('Thẻ hiện tại (currentCard):', JSON.stringify(currentCard));
            

            quizQuestionDisplay.textContent = currentCard.question;
            quizAnswerInput.value = '';
            quizFeedback.innerHTML = ''; // Xóa phản hồi cũ
            quizCheckButton.textContent = 'Kiểm tra';
            quizCheckButton.onclick = checkAnswer; // Gán lại hàm checkAnswer
            quizAnswerInput.disabled = false; // Đảm bảo ô nhập được kích hoạt
            quizAnswerInput.focus();
            quizPauseButton.disabled = false; // Kích hoạt nút Pause
        }

        function checkAnswer() {
            if (currentQuizIndex < 0 || currentQuizIndex >= quizSessionCards.length) {
                console.error("Lỗi: currentQuizIndex không hợp lệ:", currentQuizIndex);
                alert("Đã xảy ra lỗi, vui lòng thử lại.");
                forceEndQuiz();
                return;
            }

            const currentCard = quizSessionCards[currentQuizIndex];
            const userAnswer = quizAnswerInput.value.trim().toLowerCase();
            const correctAnswer = currentCard.answer.trim().toLowerCase();
            const originalCorrectAnswer = currentCard.answer;

            quizAnswerInput.disabled = true; // Vô hiệu hóa ô nhập tạm thời
            quizPauseButton.disabled = true; // Vô hiệu hóa Pause khi đang xử lý
// Xóa animation cũ trước khi thêm mới
            quizFeedback.classList.remove('animate-correct', 'animate-wrong');
// Dùng requestAnimationFrame để đảm bảo class được xóa trước khi thêm lại
            requestAnimationFrame(() => {
                if (userAnswer === correctAnswer) {
                    currentCard.correctStreak++;
                    if (currentCard.correctStreak >= 2) {
                        if (!currentCard.isMastered) {
                            currentCard.isMastered = true;
                            masteredCount++;
                            updateScoreDisplay();
                        }
                        quizFeedback.innerHTML = `<span class="correct">Đúng rồi! Đã thuộc câu này! 🎉 (${currentCard.correctStreak}/2)</span><br>Nhấn Enter hoặc nút 'Tiếp theo' để qua câu sau.`;
                    } else {
                        quizFeedback.innerHTML = `<span class="correct">Đúng rồi! 👍 (Lần ${currentCard.correctStreak}/2)</span><br>Nhấn Enter hoặc nút 'Tiếp theo' để qua câu sau.`;
                    }

                        // Thêm animation đúng
                        quizFeedback.classList.add('animate-correct');

                        quizCheckButton.textContent = 'Tiếp theo';
                        quizCheckButton.onclick = showNextQuestion;
                        quizCheckButton.focus();
                        quizPauseButton.disabled = false;

                    } else {
                        currentCard.correctStreak = 0;
                        quizFeedback.innerHTML = `
                            <span class="wrong">Sai rồi 😢</span>
                            <div>Đáp án đúng: ${originalCorrectAnswer}</div>
                            <div>So sánh: ${highlightDiff(userAnswer, originalCorrectAnswer)}</div>
                            <br><strong>Hãy thử lại câu này!</strong>
                        `;

                        // Thêm animation sai
                        // Lấy phần tử span chứa chữ "Sai rồi" để thêm animation
                        const wrongSpan = quizFeedback.querySelector('.wrong');
                        if (wrongSpan) {
                            wrongSpan.classList.add('animate-wrong');
                        }


                        quizCheckButton.textContent = 'Thử lại';
                        quizCheckButton.onclick = checkAnswer;
                        quizAnswerInput.disabled = false;
                        quizAnswerInput.focus();
                        quizAnswerInput.select();
                        quizPauseButton.disabled = false;
                    }

                    setTimeout(() => {
                             quizFeedback.classList.remove('animate-correct');
                             const wrongSpan = quizFeedback.querySelector('.wrong');
                             if (wrongSpan) {
                                 wrongSpan.classList.remove('animate-wrong');
                             }
                         }, 600); // Thời gian phải lớn hơn hoặc bằng thời gian animation
                    
                        });
        }
    
        function updateScoreDisplay() {
            quizScoreDisplay.textContent = `Đã thuộc: ${masteredCount}/${quizSessionCards.length}`;
        }

        function endQuiz() {
            alert(`Chúc mừng! Bạn đã thuộc tất cả ${quizSessionCards.length} thẻ trong nhóm này!`);
            localStorage.removeItem('quizProgress'); // Xóa tiến trình đã lưu khi hoàn thành
            forceEndQuiz(); // Gọi hàm dọn dẹp chung
        }

        // Hàm kết thúc quiz (do hoàn thành, tạm dừng, hoặc hủy)
        function forceEndQuiz() {
            quizMode = false;
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('flashcards').classList.remove('hidden');
            document.querySelector('.add-card').classList.remove('hidden');
            document.getElementById('quiz-controls').classList.remove('hidden'); // Hiện lại nút Start/Resume

            // Reset trạng thái quiz
            quizSessionCards = [];
            currentQuizIndex = 0;
            masteredCount = 0;
            quizScoreDisplay.textContent = '';
            quizFeedback.innerHTML = '';
            quizAnswerInput.value = '';
            quizAnswerInput.disabled = false;

            // Đặt lại nút kiểm tra về trạng thái ban đầu
            if (quizCheckButton) {
                quizCheckButton.textContent = 'Kiểm tra';
                quizCheckButton.onclick = checkAnswer;
            }
             checkPausedQuiz(); // Kiểm tra lại xem có nút Resume không (sau khi xóa progress)
        }


        // --- Chức năng Tạm dừng / Tiếp tục ---
        function pauseQuiz() {
            if (!quizMode) return;
            const cardIdsInSession = quizSessionCards.map(card => card.id || card.question); // Dùng ID nếu có, hoặc question làm key tạm

            const quizState = {
                groupId: currentGroupId,
                cardIds: cardIdsInSession,
                cardStates: quizSessionCards.map(card => ({ // Lưu trạng thái riêng của từng thẻ
                    id: card.id || card.question, // Key để khớp
                    correctStreak: card.correctStreak,
                    isMastered: card.isMastered
                })),
                currentIndex: currentQuizIndex, // Vẫn lưu index hiện tại
                mastered: masteredCount,
                timestamp: Date.now()
            };
        

            try {
                localStorage.setItem('quizProgress', JSON.stringify(quizState));
                alert("Quiz đã được tạm dừng. Bạn có thể tiếp tục sau.");
                forceEndQuiz();
            } catch (e) {
                // Kiểm tra lỗi cụ thể hơn nếu có thể
                if (e.name === 'QuotaExceededError') {
                     alert("Không thể lưu tiến trình quiz do hết dung lượng lưu trữ trình duyệt (localStorage). Hãy thử xóa bớt dữ liệu duyệt web hoặc giảm số lượng thẻ trong nhóm.");
                } else {
                     alert("Không thể lưu tiến trình quiz. Đã xảy ra lỗi không mong muốn.");
                }
                console.error("Lỗi khi lưu tiến trình quiz:", e);
            }
        }

        function resumeQuiz() {
            const savedProgress = JSON.parse(localStorage.getItem('quizProgress') || 'null');
            if (!savedProgress || !savedProgress.cardIds) { // Kiểm tra có cardIds không
                alert("Không tìm thấy tiến trình quiz đã lưu hoặc dữ liệu không hợp lệ.");
                localStorage.removeItem('quizProgress'); // Xóa dữ liệu không hợp lệ
                checkPausedQuiz();
                return;
            }

            const targetGroup = groups.find(g => g.id === savedProgress.groupId);
            if (!targetGroup) {
                alert(`Nhóm của quiz đã lưu (ID: ${savedProgress.groupId}) không còn tồn tại. Không thể tiếp tục.`);
                localStorage.removeItem('quizProgress');
                checkPausedQuiz();
                return;
            }
        
            // Khôi phục trạng thái
            currentGroupId = savedProgress.groupId;
            masteredCount = savedProgress.mastered;
            currentQuizIndex = savedProgress.currentIndex; // Sẽ được điều chỉnh lại trong showNextQuestion
        
            // Tái tạo quizSessionCards từ dữ liệu gốc và trạng thái đã lưu
            quizSessionCards = savedProgress.cardIds.map(cardIdOrQuestion => {
                const originalCard = targetGroup.cards.find(c => (c.id || c.question) === cardIdOrQuestion);
                const savedState = savedProgress.cardStates.find(s => s.id === cardIdOrQuestion);
        
                if (!originalCard) {
                    console.warn(`Không tìm thấy thẻ gốc với ID/Question: ${cardIdOrQuestion}`);
                    return null; // Bỏ qua thẻ không tìm thấy
                }
        
                return {
                    ...originalCard, // Lấy question, answer từ thẻ gốc
                    correctStreak: savedState ? savedState.correctStreak : 0,
                    isMastered: savedState ? savedState.isMastered : false
                };
            }).filter(card => card !== null); // Loại bỏ các thẻ không tìm thấy
        
            if (quizSessionCards.length === 0) {
                 alert("Không thể khôi phục thẻ cho quiz. Có thể thẻ đã bị xóa.");
                 localStorage.removeItem('quizProgress');
                 checkPausedQuiz();
                 return;
            }
        
        
            document.getElementById('group-select').value = currentGroupId;
            renderCards();
        
            startQuiz(true); // Gọi startQuiz với cờ resume = true
        }

        // Kiểm tra và hiển thị nút Resume nếu có
        function checkPausedQuiz() {
            const savedProgress = JSON.parse(localStorage.getItem('quizProgress') || 'null');
            const resumeButtonContainer = document.getElementById('quiz-controls');
            let resumeButton = document.getElementById('resume-quiz-btn');

            // Xóa nút Resume cũ nếu có
            if (resumeButton) {
                resumeButton.remove();
            }

            if (savedProgress && savedProgress.groupId === currentGroupId) {
                // Tìm tên nhóm đã lưu
                const groupName = groups.find(g => g.id === savedProgress.groupId)?.name || 'Nhóm đã lưu';
                const savedTime = new Date(savedProgress.timestamp).toLocaleString();

                // Tạo nút Resume mới
                resumeButton = document.createElement('button');
                resumeButton.id = 'resume-quiz-btn';
                resumeButton.className = 'resume-button';
                resumeButton.textContent = `Tiếp tục Quiz (${groupName} - ${savedProgress.mastered}/${savedProgress.cardIds.length} thuộc)`;
                resumeButton.title = `Lưu lúc: ${savedTime}`;
                resumeButton.onclick = resumeQuiz;

                // Thêm nút vào container (ví dụ: bên cạnh nút Start)
                resumeButtonContainer.appendChild(resumeButton);
                 document.getElementById('start-quiz-btn').textContent = "Bắt đầu Quiz Mới"; // Đổi text nút start
            } else {
                 // Nếu không có progress hoặc không khớp nhóm, đảm bảo nút Start là mặc định
                 document.getElementById('start-quiz-btn').textContent = "Bắt đầu Quiz";
            }
        }


        // --- Các hàm quản lý thẻ (render, add, edit, delete) ---
        function renderCards() {
            const container = document.getElementById('flashcards');
            container.innerHTML = '';
            const currentGroup = groups.find(g => g.id === currentGroupId);
            if (!currentGroup) {
                 container.innerHTML = "<p>Vui lòng chọn hoặc tạo một nhóm.</p>";
                 return;
            }
             if (currentGroup.cards.length === 0) {
                 container.innerHTML = "<p>Nhóm này chưa có thẻ nào. Hãy thêm thẻ!</p>";
             }

            currentGroup.cards.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'flashcard';
                // Cho phép chỉnh sửa trực tiếp trên thẻ
                const questionInput = `<input type="text" value="${escapeHtml(card.question)}" onchange="editCard(${index}, 'question', this.value)" onclick="event.stopPropagation()">`;
                const answerInput = `<input type="text" value="${escapeHtml(card.answer)}" onchange="editCard(${index}, 'answer', this.value)" onclick="event.stopPropagation()">`;

                cardEl.innerHTML = `
                    <div><strong>Q:</strong> ${questionInput}</div>
                    <div class="answer-display ${card.showAnswer ? '' : 'hidden'}"><strong>A:</strong> ${answerInput}</div>
                    <button onclick="deleteCard(${index}); event.stopPropagation();">Xóa</button>
                `;

                // Click vào thẻ (không phải input/button) để hiện/ẩn câu trả lời
                cardEl.addEventListener('click', (e) => {
                    // Chỉ toggle khi click vào vùng trống của thẻ
                    if (e.target === cardEl || e.target.tagName === 'DIV' || e.target.tagName === 'STRONG') {
                         const answerDiv = cardEl.querySelector('.answer-display');
                         if (answerDiv) {
                             answerDiv.classList.toggle('hidden');
                             // Lưu trạng thái showAnswer (tùy chọn, có thể không cần thiết nếu chỉ là tạm thời)
                             // currentGroup.cards[index].showAnswer = !answerDiv.classList.contains('hidden');
                             // saveGroups();
                         }
                    }
                });

                container.appendChild(cardEl);
            });
        }

        // Hàm chống XSS cơ bản khi hiển thị value trong input
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }


        async function editCard(index, field, value) {
            const currentGroup = groups.find(g => g.id === currentGroupId);
            if (!currentGroup || !currentGroup.cards[index]) return;
        
            const trimmedValue = value.trim();
            const cardToEdit = currentGroup.cards[index];
            const originalValue = cardToEdit[field]; // Lưu giá trị cũ
        
            if (!trimmedValue) {
                alert("Câu hỏi và câu trả lời không được để trống!");
                renderCards(); // Render lại để reset input về giá trị cũ (originalValue)
                return;
            }
        
            // Cập nhật giá trị trong mảng bộ nhớ
            cardToEdit[field] = trimmedValue;
        
            try {
                await saveGroupDB(currentGroup); // Lưu toàn bộ group đã cập nhật vào DB
                // Không cần render lại ngay nếu thành công, vì input đã cập nhật
            } catch (error) {
                alert("Lỗi khi cập nhật thẻ.");
                console.error("Lỗi editCard:", error);
                // Hoàn tác thay đổi trong bộ nhớ nếu lưu DB lỗi
                cardToEdit[field] = originalValue;
                renderCards(); // Render lại để hiển thị giá trị cũ
            }
        }
        

        async function addCard() {
            const questionInput = document.getElementById('question');
            const answerInput = document.getElementById('answer');
            const question = questionInput.value.trim();
            const answer = answerInput.value.trim();
        
            if (question && answer) {
                const currentGroup = groups.find(g => g.id === currentGroupId);
                if (!currentGroup) {
                    alert("Lỗi: Không tìm thấy nhóm hiện tại để thêm thẻ.");
                    return;
                }
        
                const newCard = {
                    // Có thể thêm ID duy nhất cho thẻ nếu cần xóa/sửa chính xác hơn sau này
                    // id: `card_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    question,
                    answer,
                    showAnswer: false
                };
        
                currentGroup.cards.push(newCard); // Thêm vào mảng trong bộ nhớ
        
                try {
                    await saveGroupDB(currentGroup); // Lưu toàn bộ group đã cập nhật vào DB
                    renderCards(); // Cập nhật danh sách thẻ UI
                    initGroups(); // Cập nhật số lượng thẻ trong select
                    questionInput.value = '';
                    answerInput.value = '';
                    questionInput.focus();
                } catch (error) {
                    alert("Lỗi khi thêm thẻ mới.");
                    console.error("Lỗi addCard:", error);
                    // Hoàn tác: Xóa thẻ vừa thêm khỏi mảng nếu lưu DB lỗi
                    currentGroup.cards.pop();
                    renderCards();
                    initGroups();
                }
            } else {
                alert("Vui lòng nhập cả câu hỏi và câu trả lời.");
            }
        }

        async function deleteCard(index) {
            const currentGroup = groups.find(g => g.id === currentGroupId);
            if (!currentGroup || !currentGroup.cards[index]) return;
        
            const cardToDelete = currentGroup.cards[index];
        
            if (confirm(`Bạn có chắc muốn xóa thẻ:\nQ: ${cardToDelete.question}\nA: ${cardToDelete.answer}`)) {
                const removedCard = currentGroup.cards.splice(index, 1)[0]; // Xóa khỏi mảng và lưu lại phòng lỗi
        
                try {
                    await saveGroupDB(currentGroup); // Lưu group đã cập nhật vào DB
                    renderCards(); // Cập nhật UI
                    initGroups(); // Cập nhật số lượng thẻ
                } catch (error) {
                    alert("Lỗi khi xóa thẻ.");
                    console.error("Lỗi deleteCard:", error);
                    // Hoàn tác: Thêm thẻ lại vào mảng nếu lưu DB lỗi
                    currentGroup.cards.splice(index, 0, removedCard);
                    renderCards();
                    initGroups();
                }
            }
        }

        async function initializeApp() {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-switch').checked = true;
            } else {
                document.body.classList.remove('dark-mode');
            }

            quizCheckButton = document.getElementById('quiz-check-btn');
            quizPauseButton = document.getElementById('quiz-pause-btn');
            quizAnswerInput = document.getElementById('quiz-answer'); // Gán giá trị ở đây
            quizFeedback = document.getElementById('quiz-feedback');
            quizScoreDisplay = document.getElementById('quiz-score');
            quizQuestionDisplay = document.getElementById('quiz-question');
            const questionInput = document.getElementById('question'); // Lấy tham chiếu luôn ở đây
            const answerInput = document.getElementById('answer');     // Lấy tham chiếu luôn ở đây

            try {
                await openDB();
        
                // --- BƯỚC CHUYỂN ĐỔI (Migration) - Chỉ chạy một lần ---
                const migrationDone = localStorage.getItem('indexedDB_migration_complete');
                if (!migrationDone) {
                    console.log("Kiểm tra dữ liệu localStorage cũ để chuyển đổi...");
                    const oldLocalStorageData = localStorage.getItem('groups');
                    if (oldLocalStorageData) {
                        try {
                            const oldGroups = JSON.parse(oldLocalStorageData);
                            if (Array.isArray(oldGroups) && oldGroups.length > 0) {
                                console.log(`Tìm thấy ${oldGroups.length} nhóm cũ trong localStorage. Bắt đầu chuyển đổi...`);
                                // Kiểm tra xem DB có trống không trước khi ghi đè
                                const currentDBGroups = await getAllGroupsDB();
                                if (currentDBGroups.length === 0) {
                                     // Chỉ chuyển đổi nếu DB trống để tránh ghi đè dữ liệu mới hơn
                                    for (const group of oldGroups) {
                                        // Đảm bảo group có ID hợp lệ (localStorage cũ có thể không có)
                                        if (!group.id) {
                                            group.id = Date.now().toString() + Math.random().toString(36).substring(2, 9); // Tạo ID nếu thiếu
                                            console.warn(`Nhóm "${group.name}" thiếu ID, đã tạo ID mới: ${group.id}`);
                                        }
                                        // Đảm bảo cards là mảng
                                        if (!Array.isArray(group.cards)) {
                                            group.cards = [];
                                        }
                                        await saveGroupDB(group);
                                    }
                                    console.log("Chuyển đổi dữ liệu từ localStorage sang IndexedDB thành công!");
                                    // Đánh dấu đã hoàn thành chuyển đổi
                                    localStorage.setItem('indexedDB_migration_complete', 'true');
                                    // Không xóa localStorage ngay, để phòng trường hợp cần kiểm tra lại
                                    // localStorage.removeItem('groups');
                                } else {
                                     console.log("IndexedDB đã có dữ liệu, bỏ qua chuyển đổi từ localStorage.");
                                     localStorage.setItem('indexedDB_migration_complete', 'true'); // Đánh dấu đã kiểm tra
                                }
                            } else {
                                 console.log("Không có dữ liệu hợp lệ trong localStorage cũ hoặc mảng rỗng.");
                                 localStorage.setItem('indexedDB_migration_complete', 'true'); // Đánh dấu đã kiểm tra
                            }
                        } catch (parseError) {
                            console.error("Lỗi khi đọc hoặc chuyển đổi dữ liệu localStorage cũ:", parseError);
                             // Vẫn đánh dấu để không thử lại liên tục nếu dữ liệu lỗi
                             localStorage.setItem('indexedDB_migration_complete', 'true');
                        }
                    } else {
                         console.log("Không tìm thấy dữ liệu 'groups' trong localStorage cũ.");
                         localStorage.setItem('indexedDB_migration_complete', 'true'); // Đánh dấu đã kiểm tra
                    }
                }
                // --- KẾT THÚC BƯỚC CHUYỂN ĐỔI ---
        
        
                // Load dữ liệu nhóm từ IndexedDB (bây giờ có thể chứa dữ liệu đã chuyển đổi)
                groups = await getAllGroupsDB();
                console.log('>>> Dữ liệu nhóm được gán vào biến groups:', JSON.stringify(groups)); // Log quan trọng!

                if (groups.length === 0) {
                    console.log("Không có nhóm nào trong DB, tạo nhóm mặc định.");
                    const defaultGroup = { id: 'default', name: 'Mặc định', cards: [] };
                    await saveGroupDB(defaultGroup); // Lưu nhóm mặc định vào DB
                    groups.push(defaultGroup); // Thêm vào mảng hiện tại
                }

                initGroups();
                renderCards();
                checkPausedQuiz()

                // --- Event Listeners ---
        // Thêm thẻ khi nhấn Enter ở ô câu trả lời (phần thêm thẻ)
        document.getElementById('answer').addEventListener('keypress', function(e) {
        });

        // --- Chạy khởi tạo khi trang tải xong ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        answerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addCard();
            }
        });

        // Xử lý Enter trong ô trả lời quiz
        quizAnswerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Ngăn submit form (nếu có)
                // Kích hoạt hành động hiện tại của nút Kiểm tra/Tiếp theo/Thử lại
                if (quizCheckButton && !quizAnswerInput.disabled) { // Chỉ kích hoạt nếu input đang bật
                    quizCheckButton.click();
                }
            }
        });

        // Tab navigation
        questionInput.addEventListener('keydown', function(e) {
            if (e.key === 'Tab' && !e.shiftKey) {
                e.preventDefault();
                answerInput.focus();
            }
        });
        // Listener thứ hai cho 'answer' (xem lại có cần không)
        answerInput.addEventListener('keydown', function(e) {
             if (e.key === 'Tab') {
                 e.preventDefault();
                 if (e.shiftKey) {
                      questionInput.focus();
                 } else {
                     document.querySelector('.add-card button').focus();
                 }
             }
         });
        // --- KẾT THÚC DI CHUYỂN EVENT LISTENERS ---
            } catch (error) {
                console.error("Lỗi khởi tạo ứng dụng với IndexedDB:", error);
                alert("Không thể tải dữ liệu nhóm. Vui lòng thử tải lại trang.");
                // Có thể hiển thị thông báo lỗi trên UI
            }
        }  
        document.addEventListener('DOMContentLoaded', initializeApp); // Listener này giữ nguyên
    </script>
</body>
</html>