<!DOCTYPE html>
<html>
<head>
    <title>Flashcard C√° Nh√¢n</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 10px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        :root {
            --bg-color: #ffffff;
            --text-color: #000000;
            --input-bg: #ffffff;
            --input-text: #000000;
            --card-bg: #f9f9f9;
            --border-color: #ccc;
            --button-bg: #e0e0e0;
            --button-text: #000;
            --hover-bg: #d0d0d0;
            --pause-bg: #ff9800; /* M√†u n√∫t Pause */
            --pause-hover-bg: #e68a00;
        }

        .dark-mode {
            --bg-color: #121212;
            --text-color: #f0f0f0;
            --input-bg: #1e1e1e;
            --input-text: #f0f0f0;
            --card-bg: #1e1e1e;
            --border-color: #444;
            --button-bg: #3a3a3a;
            --button-text: #fff;
            --hover-bg: #555;
            --pause-bg: #ff9800;
            --pause-hover-bg: #e68a00;
        }

        .theme-toggle {
            margin-bottom: 20px;
            text-align: right;
        }

        .group-management {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .add-card {
            margin-bottom: 20px;
        }

        input[type="text"], select {
            width: 200px;
            padding: 8px;
            margin-right: 10px;
            background-color: var(--input-bg);
            color: var(--input-text);
            border: 1px solid var(--border-color);
        }

        button {
            padding: 8px 15px;
            color: var(--button-text);
            background-color: var(--button-bg);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: var(--hover-bg);
        }

        .flashcard {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            transition: 0.3s;
            word-wrap: break-word;
            white-space: normal;
            border-radius: 5px;
        }

        .flashcard input[type="text"] {
            width: 100%;
            box-sizing: border-box;
            background-color: var(--input-bg);
            color: var(--input-text);
            border: 1px solid var(--border-color);
        }

        .flashcard:hover {
            box-shadow: 0 2px 10px rgba(255, 255, 255, 0.1);
        }

        .hidden {
            display: none;
        }

        #quiz-container {
            margin-top: 30px;
            padding: 20px;
            background: var(--card-bg);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        #quiz-answer {
            padding: 8px;
            width: 300px;
            margin: 10px 0;
            background-color: var(--input-bg);
            color: var(--input-text);
            border: 1px solid var(--border-color);
        }

        .correct {
            color: #4CAF50;
            font-weight: bold;
        }

        .wrong {
            color: #f44336;
            font-weight: bold;
        }

        #group-select {
            flex-grow: 1;
            min-width: 200px;
        }

        .quiz-button {
            background: #2196F3;
            color: white;
        }

        .delete-group-btn {
            background: #d32f2f;
            color: white;
        }

        .delete-group-btn:hover {
            background: #b71c1c;
        }
        
        .resume-button { 
            background: #4CAF50; 
            color: white; 
            margin-left: 10px; 
        }

        .resume-button:hover { 
            background: #388E3C; 
        }

        .pause-button { 
            background-color: var(--pause-bg); 
            color: white; 
            margin-left: 10px; 
        }
        .pause-button:hover { 
            background-color: var(--pause-hover-bg); 
        }

    </style>
</head>
<body>
    <!-- Toggle theme switch -->
    <div class="theme-toggle">
        <label>
            <input type="checkbox" id="theme-switch" onchange="toggleTheme()"> Dark Mode
        </label>
    </div>
    <div class="group-management">
        <input type="text" id="new-group" placeholder="T√™n nh√≥m m·ªõi">
        <button onclick="createGroup()">T·∫°o nh√≥m</button>
        <select id="group-select" onchange="changeGroup(this.value)"></select>
        <button class="delete-group-btn" onclick="deleteCurrentGroup()">X√≥a nh√≥m</button>
        <input type="text" id="rename-group" placeholder="T√™n m·ªõi...">
        <button onclick="renameGroup()">ƒê·ªïi t√™n nh√≥m</button>

    </div>

    <h1>Flashcard c·ªßa b·∫°n</h1>
    
    <div class="add-card">
        <input type="text" id="question" placeholder="C√¢u h·ªèi...">
        <input type="text" id="answer" placeholder="C√¢u tr·∫£ l·ªùi...">
        <button onclick="addCard()">Th√™m th·∫ª</button>
    </div>

    <!-- N√∫t B·∫Øt ƒë·∫ßu/Ti·∫øp t·ª•c Quiz -->
    <div id="quiz-controls">
        <button class="quiz-button" id="start-quiz-btn" onclick="startQuiz()">B·∫Øt ƒë·∫ßu Quiz</button>
    </div>

    <div id="quiz-container" class="hidden">
        <div id="quiz-question"></div>
        <input type="text" id="quiz-answer" placeholder="Nh·∫≠p c√¢u tr·∫£ l·ªùi...">
        <button id="quiz-check-btn" onclick="checkAnswer()">Ki·ªÉm tra</button>
        <button id="quiz-pause-btn" class="pause-button" onclick="pauseQuiz()">T·∫°m d·ª´ng</button>
        <div id="quiz-feedback"></div>
        <div id="quiz-score"></div>
    </div>

    <div id="flashcards"></div>

    <script>
        // --- IndexedDB Helper Functions ---
const DB_NAME = 'FlashcardAppDB';
const DB_VERSION = 1; // TƒÉng version n·∫øu thay ƒë·ªïi c·∫•u tr√∫c (th√™m/x√≥a object store/index)
const GROUP_STORE_NAME = 'groups';
let db; // Bi·∫øn l∆∞u tr·ªØ ƒë·ªëi t∆∞·ª£ng database

// M·ªü (ho·∫∑c t·∫°o) c∆° s·ªü d·ªØ li·ªáu
function openDB() {
    return new Promise((resolve, reject) => {
        if (db) { // N·∫øu ƒë√£ m·ªü, tr·∫£ v·ªÅ ngay
            return resolve(db);
        }
        console.log(`M·ªü ${DB_NAME} version ${DB_VERSION}`);
        const request = indexedDB.open(DB_NAME, DB_VERSION);

        request.onerror = (event) => {
            console.error("L·ªói khi m·ªü IndexedDB:", event.target.error);
            reject("L·ªói khi m·ªü DB");
        };

        request.onsuccess = (event) => {
            db = event.target.result;
            console.log("IndexedDB ƒë√£ m·ªü th√†nh c√¥ng.");
            resolve(db);
        };

        // Ch·ªâ ch·∫°y khi t·∫°o DB l·∫ßn ƒë·∫ßu ho·∫∑c n√¢ng c·∫•p version
        request.onupgradeneeded = (event) => {
            console.log("Ch·∫°y onupgradeneeded...");
            const tempDb = event.target.result;
            if (!tempDb.objectStoreNames.contains(GROUP_STORE_NAME)) {
                console.log(`T·∫°o object store: ${GROUP_STORE_NAME}`);
                tempDb.createObjectStore(GROUP_STORE_NAME, { keyPath: 'id' });
            }
        };
    });
}

async function getAllGroupsDB() {
    const dbInstance = await openDB();
    return new Promise((resolve, reject) => {
        const transaction = dbInstance.transaction(GROUP_STORE_NAME, 'readonly');
        const store = transaction.objectStore(GROUP_STORE_NAME);
        const request = store.getAll(); // L·∫•y t·∫•t c·∫£ object

        request.onerror = (event) => {
            console.error("L·ªói khi l·∫•y t·∫•t c·∫£ nh√≥m:", event.target.error);
            reject("L·ªói ƒë·ªçc d·ªØ li·ªáu nh√≥m");
        };

        request.onsuccess = (event) => {
            resolve(event.target.result || []); // Tr·∫£ v·ªÅ m·∫£ng k·∫øt qu·∫£ ho·∫∑c m·∫£ng r·ªóng
        };
    });
}

async function saveGroupDB(group) {
    const dbInstance = await openDB();
    return new Promise((resolve, reject) => {
        const transaction = dbInstance.transaction(GROUP_STORE_NAME, 'readwrite');
        const store = transaction.objectStore(GROUP_STORE_NAME);
        const request = store.put(group); // put s·∫Ω th√™m m·ªõi ho·∫∑c c·∫≠p nh·∫≠t n·∫øu key ƒë√£ t·ªìn t·∫°i

        request.onerror = (event) => {
            console.error("L·ªói khi l∆∞u nh√≥m:", event.target.error, 'Data:', group); // Th√™m log data
            reject("L·ªói l∆∞u d·ªØ li·ªáu nh√≥m");
        };

        request.onsuccess = (event) => {
            console.log('saveGroupDB th√†nh c√¥ng! Key:', event.target.result, 'Data:', group); // Th√™m log data
            resolve(event.target.result);
        };
    });
}

async function deleteGroupDB(groupId) {
    const dbInstance = await openDB();
    return new Promise((resolve, reject) => {
        const transaction = dbInstance.transaction(GROUP_STORE_NAME, 'readwrite');
        const store = transaction.objectStore(GROUP_STORE_NAME);
        const request = store.delete(groupId);

        request.onerror = (event) => {
            console.error("L·ªói khi x√≥a nh√≥m:", event.target.error);
            reject("L·ªói x√≥a d·ªØ li·ªáu nh√≥m");
        };

        request.onsuccess = (event) => {
            console.log(`ƒê√£ x√≥a nh√≥m ID: ${groupId}`);
            resolve();
        };
    });
}

// L·∫•y m·ªôt nh√≥m c·ª• th·ªÉ b·∫±ng ID (h·ªØu √≠ch cho vi·ªác c·∫≠p nh·∫≠t th·∫ª)
async function getGroupByIdDB(groupId) {
    const dbInstance = await openDB();
    return new Promise((resolve, reject) => {
        const transaction = dbInstance.transaction(GROUP_STORE_NAME, 'readonly');
        const store = transaction.objectStore(GROUP_STORE_NAME);
        const request = store.get(groupId);
        
        request.onerror = (event) => {
            console.error(`L·ªói khi l·∫•y nh√≥m ID ${groupId}:`, event.target.error);
            reject("L·ªói ƒë·ªçc d·ªØ li·ªáu nh√≥m");
        };

        request.onsuccess = (event) => {
            resolve(event.target.result); // Tr·∫£ v·ªÅ group object ho·∫∑c undefined n·∫øu kh√¥ng t√¨m th·∫•y
        };
    });
}
        
        let groups = [];
        let currentGroupId = 'default';
        let quizMode = false;
        let quizCheckButton = null; // Tham chi·∫øu ƒë·∫øn n√∫t Ki·ªÉm tra/Ti·∫øp theo/Th·ª≠ l·∫°i
        let quizPauseButton = null; // Tham chi·∫øu ƒë·∫øn n√∫t T·∫°m d·ª´ng
        let quizAnswerInput = null; // Tham chi·∫øu ƒë·∫øn √¥ nh·∫≠p c√¢u tr·∫£ l·ªùi quiz
        let quizFeedback = null;    // Tham chi·∫øu ƒë·∫øn ph·∫ßn ph·∫£n h·ªìi
        let quizScoreDisplay = null; // Tham chi·∫øu ƒë·∫øn hi·ªÉn th·ªã ƒëi·ªÉm
        let quizQuestionDisplay = null; // Tham chi·∫øu ƒë·∫øn hi·ªÉn th·ªã c√¢u h·ªèi

        // --- Bi·∫øn cho logic quiz m·ªõi ---
        let quizSessionCards = []; // M·∫£ng th·∫ª d√πng trong phi√™n quiz hi·ªán t·∫°i
        let currentQuizIndex = 0;  // Ch·ªâ s·ªë th·∫ª hi·ªán t·∫°i trong quizSessionCards
        let masteredCount = 0;     // S·ªë th·∫ª ƒë√£ thu·ªôc (ƒë√∫ng 2 l·∫ßn li√™n ti·∫øp)

        // H√†m chuy·ªÉn ƒë·ªïi giao di·ªán
        function toggleTheme() {
            const isDark = document.getElementById('theme-switch').checked;
            if (isDark) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
            }
        }

        // Kh·ªüi t·∫°o danh s√°ch nh√≥m
        function initGroups() {
            const select = document.getElementById('group-select');
            select.innerHTML = groups.map(group => `
                <option value="${group.id}" ${group.id === currentGroupId ? 'selected' : ''}>
                    ${group.name} (${group.cards.length} th·∫ª)
                </option>
            `).join('');
            // Sau khi c·∫≠p nh·∫≠t select, ki·ªÉm tra l·∫°i quiz ƒëang t·∫°m d·ª´ng
            checkPausedQuiz();
        }

        // H√†m t√¥ m√†u s·ª± kh√°c bi·ªát (gi·ªØ nguy√™n)
        function highlightDiff(wrong, correct) {
            // ... (code h√†m highlightDiff kh√¥ng ƒë·ªïi) ...
             const wrongWords = wrong.trim().split(/\s+/);
            const correctWords = correct.trim().split(/\s+/);
            let result = [];

            const maxLength = Math.max(wrongWords.length, correctWords.length);
            for (let i = 0; i < maxLength; i++) {
                const wrongWord = wrongWords[i] || '';
                const correctWord = correctWords[i] || '';
                if (wrongWord.toLowerCase() === correctWord.toLowerCase()) { // So s√°nh kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng
                    result.push(correctWord);
                } else {
                    // Hi·ªÉn th·ªã t·ª´ ƒë√∫ng m√†u ƒë·ªè, t·ª´ sai g·∫°ch ngang (t√πy ch·ªçn)
                     result.push(`<span style="color: red; font-weight: bold;">${correctWord || '[thi·∫øu]'}</span>` + (wrongWord ? ` <s style="color: grey;">${wrongWord}</s>` : ''));
                    // Ho·∫∑c ch·ªâ hi·ªÉn th·ªã t·ª´ ƒë√∫ng:
                    // result.push(`<span style="color: red; font-weight: bold">${correctWord || '[thi·∫øu]'}</span>`);
                }
            }
            return result.join(' ');
        }

        // T·∫°o nh√≥m m·ªõi
        async function createGroup() {
            const groupName = document.getElementById('new-group').value.trim();
            if (!groupName) return;
            const newGroupId = Date.now().toString(); // T·∫°o ID duy nh·∫•t
            const newGroup = { id: newGroupId, name: groupName, cards: [] };
        
            try {
                await saveGroupDB(newGroup); // L∆∞u v√†o DB
                groups.push(newGroup); // Th√™m v√†o m·∫£ng trong b·ªô nh·ªõ
                initGroups(); // C·∫≠p nh·∫≠t UI
                document.getElementById('new-group').value = '';
                changeGroup(newGroup.id); // Chuy·ªÉn sang nh√≥m m·ªõi (h√†m n√†y c·∫ßn ƒë·∫£m b·∫£o x·ª≠ l√Ω async n·∫øu c·∫ßn)
            } catch (error) {
                alert("L·ªói khi t·∫°o nh√≥m m·ªõi.");
                console.error("L·ªói createGroup:", error);
            }
        }

        // Thay ƒë·ªïi nh√≥m hi·ªán t·∫°i
        function changeGroup(groupId) {
            // N·∫øu ƒëang trong quiz, kh√¥ng cho ƒë·ªïi nh√≥m (ho·∫∑c h·ªèi x√°c nh·∫≠n h·ªßy quiz)
            if (quizMode) {
                if (!confirm("B·∫°n ƒëang trong quiz. Chuy·ªÉn nh√≥m s·∫Ω h·ªßy ti·∫øn tr√¨nh quiz hi·ªán t·∫°i. B·∫°n c√≥ ch·∫Øc ch·∫Øn?")) {
                    // ƒê·∫∑t l·∫°i select v·ªÅ gi√° tr·ªã c≈©
                    document.getElementById('group-select').value = currentGroupId;
                    return;
                }
                // N·∫øu x√°c nh·∫≠n, k·∫øt th√∫c quiz hi·ªán t·∫°i m√† kh√¥ng l∆∞u
                forceEndQuiz();
            }
            currentGroupId = groupId;
            document.getElementById('group-select').value = currentGroupId; // ƒê·∫£m b·∫£o select ƒë∆∞·ª£c c·∫≠p nh·∫≠t
            renderCards();
            checkPausedQuiz(); // Ki·ªÉm tra l·∫°i n√∫t Resume cho nh√≥m m·ªõi
        }

        // X√≥a nh√≥m hi·ªán t·∫°i
        async function deleteCurrentGroup() {
            if (currentGroupId === 'default') {
                alert("Kh√¥ng th·ªÉ x√≥a nh√≥m m·∫∑c ƒë·ªãnh!");
                return;
            }
            // Ki·ªÉm tra quiz ƒëang t·∫°m d·ª´ng (v·∫´n d√πng localStorage)
            const savedProgress = JSON.parse(localStorage.getItem('quizProgress') || 'null');
            if (savedProgress && savedProgress.groupId === currentGroupId) {
                if (!confirm("Nh√≥m n√†y c√≥ ti·∫øn tr√¨nh quiz ƒëang t·∫°m d·ª´ng. X√≥a nh√≥m c≈©ng s·∫Ω x√≥a ti·∫øn tr√¨nh n√†y. B·∫°n c√≥ ch·∫Øc ch·∫Øn?")) {
                    return;
                }
                localStorage.removeItem('quizProgress');
                checkPausedQuiz();
            }
        
            const groupToDelete = groups.find(g => g.id === currentGroupId);
            if (!groupToDelete) return; // Kh√¥ng t√¨m th·∫•y nh√≥m?
        
            if (confirm(`X√≥a nh√≥m "${groupToDelete.name}" v√† to√†n b·ªô th·∫ª b√™n trong?`)) {
                try {
                    await deleteGroupDB(currentGroupId); // X√≥a kh·ªèi DB
                    groups = groups.filter(g => g.id !== currentGroupId); // X√≥a kh·ªèi m·∫£ng trong b·ªô nh·ªõ
                    currentGroupId = groups.find(g => g.id === 'default')?.id || groups[0]?.id || null; // Chuy·ªÉn v·ªÅ m·∫∑c ƒë·ªãnh ho·∫∑c nh√≥m ƒë·∫ßu ti√™n
        
                    if (!currentGroupId && groups.length === 0) {
                         // N·∫øu kh√¥ng c√≤n nh√≥m n√†o, t·∫°o l·∫°i nh√≥m m·∫∑c ƒë·ªãnh
                         console.log("Kh√¥ng c√≤n nh√≥m n√†o, t·∫°o l·∫°i nh√≥m m·∫∑c ƒë·ªãnh.");
                         const defaultGroup = { id: 'default', name: 'M·∫∑c ƒë·ªãnh', cards: [] };
                         await saveGroupDB(defaultGroup);
                         groups.push(defaultGroup);
                         currentGroupId = 'default';
                    } else if (!currentGroupId) {
                        // Tr∆∞·ªùng h·ª£p l·ªói kh√¥ng mong mu·ªën
                        console.error("Kh√¥ng th·ªÉ x√°c ƒë·ªãnh nh√≥m hi·ªán t·∫°i sau khi x√≥a.");
                        alert("ƒê√£ x·∫£y ra l·ªói sau khi x√≥a nh√≥m.");
                        currentGroupId = 'default'; // Fallback an to√†n
                    }
        
        
                    initGroups(); // C·∫≠p nh·∫≠t select box
                    renderCards(); // Render l·∫°i th·∫ª
                } catch (error) {
                    alert("L·ªói khi x√≥a nh√≥m.");
                    console.error("L·ªói deleteCurrentGroup:", error);
                }
            }
        }

        // ƒê·ªïi t√™n nh√≥m
        async function renameGroup() {
            const newName = document.getElementById('rename-group').value.trim();
            if (!newName) {
                alert("Vui l√≤ng nh·∫≠p t√™n m·ªõi cho nh√≥m.");
                return;
            }
            const currentGroup = groups.find(g => g.id === currentGroupId);
            if (!currentGroup) return;
        
            const originalName = currentGroup.name; // L∆∞u t√™n c≈© ph√≤ng l·ªói
            currentGroup.name = newName; // C·∫≠p nh·∫≠t t√™n trong m·∫£ng b·ªô nh·ªõ
        
            try {
                await saveGroupDB(currentGroup); // L∆∞u thay ƒë·ªïi v√†o DB
                initGroups(); // C·∫≠p nh·∫≠t t√™n trong select
                document.getElementById('rename-group').value = '';
                // C·∫≠p nh·∫≠t n√∫t Resume n·∫øu c·∫ßn (logic n√†y kh√¥ng ƒë·ªïi v√¨ d√πng localStorage)
                checkPausedQuiz();
            } catch (error) {
                alert("L·ªói khi ƒë·ªïi t√™n nh√≥m.");
                console.error("L·ªói renameGroup:", error);
                currentGroup.name = originalName; // Ho√†n t√°c thay ƒë·ªïi trong b·ªô nh·ªõ n·∫øu l∆∞u DB l·ªói
                initGroups(); // C·∫≠p nh·∫≠t l·∫°i UI v·ªÅ tr·∫°ng th√°i c≈©
            }
        }

        // --- Logic Quiz M·ªõi ---

        function startQuiz(resume = false) {
            if (!resume) {
                 // N·∫øu b·∫Øt ƒë·∫ßu quiz m·ªõi, x√≥a ti·∫øn tr√¨nh c≈© n·∫øu c√≥
                 localStorage.removeItem('quizProgress');
                 checkPausedQuiz(); // ·∫®n n√∫t Resume n·∫øu c√≥

                const currentGroup = groups.find(g => g.id === currentGroupId);
                if (!currentGroup || currentGroup.cards.length === 0) {
                    alert("Vui l√≤ng th√™m th·∫ª v√†o nh√≥m n√†y tr∆∞·ªõc!");
                    return;
                }

                // T·∫°o m·∫£ng th·∫ª cho phi√™n quiz
                quizSessionCards = currentGroup.cards.map(card => ({
                    ...card, // Sao ch√©p thu·ªôc t√≠nh g·ªëc (question, answer)
                    correctStreak: 0,
                    isMastered: false
                }));

                // Reset tr·∫°ng th√°i
                currentQuizIndex = 0;
                masteredCount = 0;

            } else {
                // Logic resume ƒë√£ x·ª≠ l√Ω vi·ªác kh√¥i ph·ª•c state trong resumeQuiz()
                 if (quizSessionCards.length === 0) {
                     console.error("L·ªói: Kh√¥ng th·ªÉ ti·∫øp t·ª•c quiz, kh√¥ng c√≥ d·ªØ li·ªáu th·∫ª.");
                     alert("ƒê√£ x·∫£y ra l·ªói khi ti·∫øp t·ª•c quiz. Vui l√≤ng b·∫Øt ƒë·∫ßu l·∫°i.");
                     forceEndQuiz();
                     return;
                 }
            }


            if (quizSessionCards.length === 0) {
                 alert("Nh√≥m n√†y kh√¥ng c√≥ th·∫ª n√†o ƒë·ªÉ h·ªçc!");
                 return;
            }

            console.log('B·∫Øt ƒë·∫ßu quiz. Nh√≥m hi·ªán t·∫°i:', currentGroupId);
            console.log('D·ªØ li·ªáu th·∫ª cho quiz (quizSessionCards):', JSON.stringify(quizSessionCards));

            quizMode = true;
            document.getElementById('quiz-container').classList.remove('hidden');
            document.getElementById('flashcards').classList.add('hidden');
            document.querySelector('.add-card').classList.add('hidden');
            document.getElementById('quiz-controls').classList.add('hidden'); // ·∫®n n√∫t Start/Resume

            updateScoreDisplay();
            showNextQuestion();
        }

        function showNextQuestion() {
            // Ki·ªÉm tra xem t·∫•t c·∫£ ƒë√£ master ch∆∞a
            if (masteredCount >= quizSessionCards.length) {
                endQuiz();
                return;
            }

            // T√¨m th·∫ª ch∆∞a master ti·∫øp theo
            let attempts = 0; // NgƒÉn v√≤ng l·∫∑p v√¥ h·∫°n n·∫øu c√≥ l·ªói logic
            let foundIndex = -1;

            // B·∫Øt ƒë·∫ßu t√¨m t·ª´ v·ªã tr√≠ sau v·ªã tr√≠ hi·ªán t·∫°i
            let searchIndex = (currentQuizIndex + 1) % quizSessionCards.length;

            while (attempts < quizSessionCards.length) {
                 if (!quizSessionCards[searchIndex].isMastered) {
                     foundIndex = searchIndex;
                     break;
                 }
                 searchIndex = (searchIndex + 1) % quizSessionCards.length;
                 attempts++;
            }

             // N·∫øu kh√¥ng t√¨m th·∫•y (tr∆∞·ªùng h·ª£p n√†y kh√¥ng n√™n x·∫£y ra n·∫øu masteredCount < length)
             if (foundIndex === -1) {
                 // C√≥ th·ªÉ t·∫•t c·∫£ ƒë√£ master, ki·ªÉm tra l·∫°i
                 if (quizSessionCards.every(card => card.isMastered)) {
                     endQuiz();
                     return;
                 } else {
                     // L·ªói logic kh√¥ng mong mu·ªën, th·ª≠ t√¨m t·ª´ ƒë·∫ßu
                     console.warn("Kh√¥ng t√¨m th·∫•y th·∫ª ch∆∞a master ti·∫øp theo, th·ª≠ t√¨m l·∫°i t·ª´ ƒë·∫ßu.");
                     foundIndex = quizSessionCards.findIndex(card => !card.isMastered);
                     if (foundIndex === -1) {
                         console.error("L·ªói nghi√™m tr·ªçng: Kh√¥ng t√¨m th·∫•y th·∫ª ch∆∞a master n√†o d√π masteredCount ch∆∞a ƒë·ªß.");
                         alert("ƒê√£ x·∫£y ra l·ªói trong qu√° tr√¨nh quiz. Quiz s·∫Ω k·∫øt th√∫c.");
                         forceEndQuiz();
                         return;
                     }
                 }
             }


            currentQuizIndex = foundIndex;
            const currentCard = quizSessionCards[currentQuizIndex];

            console.log('Hi·ªÉn th·ªã c√¢u h·ªèi ti·∫øp theo. Index:', currentQuizIndex);
            console.log('Th·∫ª hi·ªán t·∫°i (currentCard):', JSON.stringify(currentCard));
            

            quizQuestionDisplay.textContent = currentCard.question;
            quizAnswerInput.value = '';
            quizFeedback.innerHTML = ''; // X√≥a ph·∫£n h·ªìi c≈©
            quizCheckButton.textContent = 'Ki·ªÉm tra';
            quizCheckButton.onclick = checkAnswer; // G√°n l·∫°i h√†m checkAnswer
            quizAnswerInput.disabled = false; // ƒê·∫£m b·∫£o √¥ nh·∫≠p ƒë∆∞·ª£c k√≠ch ho·∫°t
            quizAnswerInput.focus();
            quizPauseButton.disabled = false; // K√≠ch ho·∫°t n√∫t Pause
        }

        function checkAnswer() {
            if (currentQuizIndex < 0 || currentQuizIndex >= quizSessionCards.length) {
                console.error("L·ªói: currentQuizIndex kh√¥ng h·ª£p l·ªá:", currentQuizIndex);
                alert("ƒê√£ x·∫£y ra l·ªói, vui l√≤ng th·ª≠ l·∫°i.");
                forceEndQuiz();
                return;
            }

            const currentCard = quizSessionCards[currentQuizIndex];
            const userAnswer = quizAnswerInput.value.trim().toLowerCase();
            const correctAnswer = currentCard.answer.trim().toLowerCase();
            const originalCorrectAnswer = currentCard.answer;

            quizAnswerInput.disabled = true; // V√¥ hi·ªáu h√≥a √¥ nh·∫≠p t·∫°m th·ªùi
            quizPauseButton.disabled = true; // V√¥ hi·ªáu h√≥a Pause khi ƒëang x·ª≠ l√Ω

            if (userAnswer === correctAnswer) {
                currentCard.correctStreak++;
                if (currentCard.correctStreak >= 2) {
                    if (!currentCard.isMastered) { // Ch·ªâ tƒÉng masteredCount n·∫øu th·∫ª ch∆∞a ƒë∆∞·ª£c master tr∆∞·ªõc ƒë√≥
                        currentCard.isMastered = true;
                        masteredCount++;
                        updateScoreDisplay();
                    }
                    quizFeedback.innerHTML = `<span class="correct">ƒê√∫ng r·ªìi! ƒê√£ thu·ªôc c√¢u n√†y! üéâ (${currentCard.correctStreak}/2)</span><br>Nh·∫•n Enter ho·∫∑c n√∫t 'Ti·∫øp theo' ƒë·ªÉ qua c√¢u sau.`;
                } else {
                    quizFeedback.innerHTML = `<span class="correct">ƒê√∫ng r·ªìi! üëç (L·∫ßn ${currentCard.correctStreak}/2)</span><br>Nh·∫•n Enter ho·∫∑c n√∫t 'Ti·∫øp theo' ƒë·ªÉ qua c√¢u sau.`;
                }

                // Cho ph√©p chuy·ªÉn c√¢u ti·∫øp theo
                quizCheckButton.textContent = 'Ti·∫øp theo';
                quizCheckButton.onclick = showNextQuestion;
                quizCheckButton.focus(); // Focus v√†o n√∫t "Ti·∫øp theo"
                quizPauseButton.disabled = false; // K√≠ch ho·∫°t l·∫°i Pause

            } else {
                // Tr·∫£ l·ªùi sai, reset streak v√† y√™u c·∫ßu th·ª≠ l·∫°i
                currentCard.correctStreak = 0;
                quizFeedback.innerHTML = `
                    <span class="wrong">Sai r·ªìi üò¢</span>
                    <div>ƒê√°p √°n ƒë√∫ng: ${originalCorrectAnswer}</div>
                    <div>So s√°nh: ${highlightDiff(userAnswer, originalCorrectAnswer)}</div>
                    <br><strong>H√£y th·ª≠ l·∫°i c√¢u n√†y!</strong>
                `;

                // Gi·ªØ nguy√™n c√¢u h·ªèi, cho ph√©p nh·∫≠p l·∫°i
                quizCheckButton.textContent = 'Th·ª≠ l·∫°i'; // ƒê·ªïi n√∫t th√†nh "Th·ª≠ l·∫°i"
                quizCheckButton.onclick = checkAnswer; // V·∫´n g·ªçi checkAnswer khi nh·∫•n n√∫t
                quizAnswerInput.disabled = false; // K√≠ch ho·∫°t l·∫°i √¥ nh·∫≠p
                quizAnswerInput.focus(); // Focus l·∫°i √¥ nh·∫≠p
                quizAnswerInput.select(); // Ch·ªçn to√†n b·ªô text ƒë·ªÉ d·ªÖ s·ª≠a
                quizPauseButton.disabled = false; // K√≠ch ho·∫°t l·∫°i Pause
            }
        }

        function updateScoreDisplay() {
            quizScoreDisplay.textContent = `ƒê√£ thu·ªôc: ${masteredCount}/${quizSessionCards.length}`;
        }

        function endQuiz() {
            alert(`Ch√∫c m·ª´ng! B·∫°n ƒë√£ thu·ªôc t·∫•t c·∫£ ${quizSessionCards.length} th·∫ª trong nh√≥m n√†y!`);
            localStorage.removeItem('quizProgress'); // X√≥a ti·∫øn tr√¨nh ƒë√£ l∆∞u khi ho√†n th√†nh
            forceEndQuiz(); // G·ªçi h√†m d·ªçn d·∫πp chung
        }

        // H√†m k·∫øt th√∫c quiz (do ho√†n th√†nh, t·∫°m d·ª´ng, ho·∫∑c h·ªßy)
        function forceEndQuiz() {
            quizMode = false;
            document.getElementById('quiz-container').classList.add('hidden');
            document.getElementById('flashcards').classList.remove('hidden');
            document.querySelector('.add-card').classList.remove('hidden');
            document.getElementById('quiz-controls').classList.remove('hidden'); // Hi·ªán l·∫°i n√∫t Start/Resume

            // Reset tr·∫°ng th√°i quiz
            quizSessionCards = [];
            currentQuizIndex = 0;
            masteredCount = 0;
            quizScoreDisplay.textContent = '';
            quizFeedback.innerHTML = '';
            quizAnswerInput.value = '';
            quizAnswerInput.disabled = false;

            // ƒê·∫∑t l·∫°i n√∫t ki·ªÉm tra v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
            if (quizCheckButton) {
                quizCheckButton.textContent = 'Ki·ªÉm tra';
                quizCheckButton.onclick = checkAnswer;
            }
             checkPausedQuiz(); // Ki·ªÉm tra l·∫°i xem c√≥ n√∫t Resume kh√¥ng (sau khi x√≥a progress)
        }


        // --- Ch·ª©c nƒÉng T·∫°m d·ª´ng / Ti·∫øp t·ª•c ---
        function pauseQuiz() {
            if (!quizMode) return;
            const cardIdsInSession = quizSessionCards.map(card => card.id || card.question); // D√πng ID n·∫øu c√≥, ho·∫∑c question l√†m key t·∫°m

            const quizState = {
                groupId: currentGroupId,
                cardIds: cardIdsInSession,
                cardStates: quizSessionCards.map(card => ({ // L∆∞u tr·∫°ng th√°i ri√™ng c·ªßa t·ª´ng th·∫ª
                    id: card.id || card.question, // Key ƒë·ªÉ kh·ªõp
                    correctStreak: card.correctStreak,
                    isMastered: card.isMastered
                })),
                currentIndex: currentQuizIndex, // V·∫´n l∆∞u index hi·ªán t·∫°i
                mastered: masteredCount,
                timestamp: Date.now()
            };
        

            try {
                localStorage.setItem('quizProgress', JSON.stringify(quizState));
                alert("Quiz ƒë√£ ƒë∆∞·ª£c t·∫°m d·ª´ng. B·∫°n c√≥ th·ªÉ ti·∫øp t·ª•c sau.");
                forceEndQuiz();
            } catch (e) {
                // Ki·ªÉm tra l·ªói c·ª• th·ªÉ h∆°n n·∫øu c√≥ th·ªÉ
                if (e.name === 'QuotaExceededError') {
                     alert("Kh√¥ng th·ªÉ l∆∞u ti·∫øn tr√¨nh quiz do h·∫øt dung l∆∞·ª£ng l∆∞u tr·ªØ tr√¨nh duy·ªát (localStorage). H√£y th·ª≠ x√≥a b·ªõt d·ªØ li·ªáu duy·ªát web ho·∫∑c gi·∫£m s·ªë l∆∞·ª£ng th·∫ª trong nh√≥m.");
                } else {
                     alert("Kh√¥ng th·ªÉ l∆∞u ti·∫øn tr√¨nh quiz. ƒê√£ x·∫£y ra l·ªói kh√¥ng mong mu·ªën.");
                }
                console.error("L·ªói khi l∆∞u ti·∫øn tr√¨nh quiz:", e);
            }
        }

        function resumeQuiz() {
            const savedProgress = JSON.parse(localStorage.getItem('quizProgress') || 'null');
            if (!savedProgress || !savedProgress.cardIds) { // Ki·ªÉm tra c√≥ cardIds kh√¥ng
                alert("Kh√¥ng t√¨m th·∫•y ti·∫øn tr√¨nh quiz ƒë√£ l∆∞u ho·∫∑c d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá.");
                localStorage.removeItem('quizProgress'); // X√≥a d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá
                checkPausedQuiz();
                return;
            }

            const targetGroup = groups.find(g => g.id === savedProgress.groupId);
            if (!targetGroup) {
                alert(`Nh√≥m c·ªßa quiz ƒë√£ l∆∞u (ID: ${savedProgress.groupId}) kh√¥ng c√≤n t·ªìn t·∫°i. Kh√¥ng th·ªÉ ti·∫øp t·ª•c.`);
                localStorage.removeItem('quizProgress');
                checkPausedQuiz();
                return;
            }
        
            // Kh√¥i ph·ª•c tr·∫°ng th√°i
            currentGroupId = savedProgress.groupId;
            masteredCount = savedProgress.mastered;
            currentQuizIndex = savedProgress.currentIndex; // S·∫Ω ƒë∆∞·ª£c ƒëi·ªÅu ch·ªânh l·∫°i trong showNextQuestion
        
            // T√°i t·∫°o quizSessionCards t·ª´ d·ªØ li·ªáu g·ªëc v√† tr·∫°ng th√°i ƒë√£ l∆∞u
            quizSessionCards = savedProgress.cardIds.map(cardIdOrQuestion => {
                const originalCard = targetGroup.cards.find(c => (c.id || c.question) === cardIdOrQuestion);
                const savedState = savedProgress.cardStates.find(s => s.id === cardIdOrQuestion);
        
                if (!originalCard) {
                    console.warn(`Kh√¥ng t√¨m th·∫•y th·∫ª g·ªëc v·ªõi ID/Question: ${cardIdOrQuestion}`);
                    return null; // B·ªè qua th·∫ª kh√¥ng t√¨m th·∫•y
                }
        
                return {
                    ...originalCard, // L·∫•y question, answer t·ª´ th·∫ª g·ªëc
                    correctStreak: savedState ? savedState.correctStreak : 0,
                    isMastered: savedState ? savedState.isMastered : false
                };
            }).filter(card => card !== null); // Lo·∫°i b·ªè c√°c th·∫ª kh√¥ng t√¨m th·∫•y
        
            if (quizSessionCards.length === 0) {
                 alert("Kh√¥ng th·ªÉ kh√¥i ph·ª•c th·∫ª cho quiz. C√≥ th·ªÉ th·∫ª ƒë√£ b·ªã x√≥a.");
                 localStorage.removeItem('quizProgress');
                 checkPausedQuiz();
                 return;
            }
        
        
            document.getElementById('group-select').value = currentGroupId;
            renderCards();
        
            startQuiz(true); // G·ªçi startQuiz v·ªõi c·ªù resume = true
        }

        // Ki·ªÉm tra v√† hi·ªÉn th·ªã n√∫t Resume n·∫øu c√≥
        function checkPausedQuiz() {
            const savedProgress = JSON.parse(localStorage.getItem('quizProgress') || 'null');
            const resumeButtonContainer = document.getElementById('quiz-controls');
            let resumeButton = document.getElementById('resume-quiz-btn');

            // X√≥a n√∫t Resume c≈© n·∫øu c√≥
            if (resumeButton) {
                resumeButton.remove();
            }

            if (savedProgress && savedProgress.groupId === currentGroupId) {
                // T√¨m t√™n nh√≥m ƒë√£ l∆∞u
                const groupName = groups.find(g => g.id === savedProgress.groupId)?.name || 'Nh√≥m ƒë√£ l∆∞u';
                const savedTime = new Date(savedProgress.timestamp).toLocaleString();

                // T·∫°o n√∫t Resume m·ªõi
                resumeButton = document.createElement('button');
                resumeButton.id = 'resume-quiz-btn';
                resumeButton.className = 'resume-button';
                resumeButton.textContent = `Ti·∫øp t·ª•c Quiz (${groupName} - ${savedProgress.mastered}/${savedProgress.sessionCards.length} thu·ªôc)`;
                resumeButton.title = `L∆∞u l√∫c: ${savedTime}`;
                resumeButton.onclick = resumeQuiz;

                // Th√™m n√∫t v√†o container (v√≠ d·ª•: b√™n c·∫°nh n√∫t Start)
                resumeButtonContainer.appendChild(resumeButton);
                 document.getElementById('start-quiz-btn').textContent = "B·∫Øt ƒë·∫ßu Quiz M·ªõi"; // ƒê·ªïi text n√∫t start
            } else {
                 // N·∫øu kh√¥ng c√≥ progress ho·∫∑c kh√¥ng kh·ªõp nh√≥m, ƒë·∫£m b·∫£o n√∫t Start l√† m·∫∑c ƒë·ªãnh
                 document.getElementById('start-quiz-btn').textContent = "B·∫Øt ƒë·∫ßu Quiz";
            }
        }


        // --- C√°c h√†m qu·∫£n l√Ω th·∫ª (render, add, edit, delete) ---
        function renderCards() {
            const container = document.getElementById('flashcards');
            container.innerHTML = '';
            const currentGroup = groups.find(g => g.id === currentGroupId);
            if (!currentGroup) {
                 container.innerHTML = "<p>Vui l√≤ng ch·ªçn ho·∫∑c t·∫°o m·ªôt nh√≥m.</p>";
                 return;
            }
             if (currentGroup.cards.length === 0) {
                 container.innerHTML = "<p>Nh√≥m n√†y ch∆∞a c√≥ th·∫ª n√†o. H√£y th√™m th·∫ª!</p>";
             }

            currentGroup.cards.forEach((card, index) => {
                const cardEl = document.createElement('div');
                cardEl.className = 'flashcard';
                // Cho ph√©p ch·ªânh s·ª≠a tr·ª±c ti·∫øp tr√™n th·∫ª
                const questionInput = `<input type="text" value="${escapeHtml(card.question)}" onchange="editCard(${index}, 'question', this.value)" onclick="event.stopPropagation()">`;
                const answerInput = `<input type="text" value="${escapeHtml(card.answer)}" onchange="editCard(${index}, 'answer', this.value)" onclick="event.stopPropagation()">`;

                cardEl.innerHTML = `
                    <div><strong>Q:</strong> ${questionInput}</div>
                    <div class="answer-display ${card.showAnswer ? '' : 'hidden'}"><strong>A:</strong> ${answerInput}</div>
                    <button onclick="deleteCard(${index}); event.stopPropagation();">X√≥a</button>
                `;

                // Click v√†o th·∫ª (kh√¥ng ph·∫£i input/button) ƒë·ªÉ hi·ªán/·∫©n c√¢u tr·∫£ l·ªùi
                cardEl.addEventListener('click', (e) => {
                    // Ch·ªâ toggle khi click v√†o v√πng tr·ªëng c·ªßa th·∫ª
                    if (e.target === cardEl || e.target.tagName === 'DIV' || e.target.tagName === 'STRONG') {
                         const answerDiv = cardEl.querySelector('.answer-display');
                         if (answerDiv) {
                             answerDiv.classList.toggle('hidden');
                             // L∆∞u tr·∫°ng th√°i showAnswer (t√πy ch·ªçn, c√≥ th·ªÉ kh√¥ng c·∫ßn thi·∫øt n·∫øu ch·ªâ l√† t·∫°m th·ªùi)
                             // currentGroup.cards[index].showAnswer = !answerDiv.classList.contains('hidden');
                             // saveGroups();
                         }
                    }
                });

                container.appendChild(cardEl);
            });
        }

        // H√†m ch·ªëng XSS c∆° b·∫£n khi hi·ªÉn th·ªã value trong input
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }


        async function editCard(index, field, value) {
            const currentGroup = groups.find(g => g.id === currentGroupId);
            if (!currentGroup || !currentGroup.cards[index]) return;
        
            const trimmedValue = value.trim();
            const cardToEdit = currentGroup.cards[index];
            const originalValue = cardToEdit[field]; // L∆∞u gi√° tr·ªã c≈©
        
            if (!trimmedValue) {
                alert("C√¢u h·ªèi v√† c√¢u tr·∫£ l·ªùi kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng!");
                renderCards(); // Render l·∫°i ƒë·ªÉ reset input v·ªÅ gi√° tr·ªã c≈© (originalValue)
                return;
            }
        
            // C·∫≠p nh·∫≠t gi√° tr·ªã trong m·∫£ng b·ªô nh·ªõ
            cardToEdit[field] = trimmedValue;
        
            try {
                await saveGroupDB(currentGroup); // L∆∞u to√†n b·ªô group ƒë√£ c·∫≠p nh·∫≠t v√†o DB
                // Kh√¥ng c·∫ßn render l·∫°i ngay n·∫øu th√†nh c√¥ng, v√¨ input ƒë√£ c·∫≠p nh·∫≠t
            } catch (error) {
                alert("L·ªói khi c·∫≠p nh·∫≠t th·∫ª.");
                console.error("L·ªói editCard:", error);
                // Ho√†n t√°c thay ƒë·ªïi trong b·ªô nh·ªõ n·∫øu l∆∞u DB l·ªói
                cardToEdit[field] = originalValue;
                renderCards(); // Render l·∫°i ƒë·ªÉ hi·ªÉn th·ªã gi√° tr·ªã c≈©
            }
        }
        

        async function addCard() {
            const questionInput = document.getElementById('question');
            const answerInput = document.getElementById('answer');
            const question = questionInput.value.trim();
            const answer = answerInput.value.trim();
        
            if (question && answer) {
                const currentGroup = groups.find(g => g.id === currentGroupId);
                if (!currentGroup) {
                    alert("L·ªói: Kh√¥ng t√¨m th·∫•y nh√≥m hi·ªán t·∫°i ƒë·ªÉ th√™m th·∫ª.");
                    return;
                }
        
                const newCard = {
                    // C√≥ th·ªÉ th√™m ID duy nh·∫•t cho th·∫ª n·∫øu c·∫ßn x√≥a/s·ª≠a ch√≠nh x√°c h∆°n sau n√†y
                    // id: `card_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    question,
                    answer,
                    showAnswer: false
                };
        
                currentGroup.cards.push(newCard); // Th√™m v√†o m·∫£ng trong b·ªô nh·ªõ
        
                try {
                    await saveGroupDB(currentGroup); // L∆∞u to√†n b·ªô group ƒë√£ c·∫≠p nh·∫≠t v√†o DB
                    renderCards(); // C·∫≠p nh·∫≠t danh s√°ch th·∫ª UI
                    initGroups(); // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th·∫ª trong select
                    questionInput.value = '';
                    answerInput.value = '';
                    questionInput.focus();
                } catch (error) {
                    alert("L·ªói khi th√™m th·∫ª m·ªõi.");
                    console.error("L·ªói addCard:", error);
                    // Ho√†n t√°c: X√≥a th·∫ª v·ª´a th√™m kh·ªèi m·∫£ng n·∫øu l∆∞u DB l·ªói
                    currentGroup.cards.pop();
                    renderCards();
                    initGroups();
                }
            } else {
                alert("Vui l√≤ng nh·∫≠p c·∫£ c√¢u h·ªèi v√† c√¢u tr·∫£ l·ªùi.");
            }
        }

        async function deleteCard(index) {
            const currentGroup = groups.find(g => g.id === currentGroupId);
            if (!currentGroup || !currentGroup.cards[index]) return;
        
            const cardToDelete = currentGroup.cards[index];
        
            if (confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a th·∫ª:\nQ: ${cardToDelete.question}\nA: ${cardToDelete.answer}`)) {
                const removedCard = currentGroup.cards.splice(index, 1)[0]; // X√≥a kh·ªèi m·∫£ng v√† l∆∞u l·∫°i ph√≤ng l·ªói
        
                try {
                    await saveGroupDB(currentGroup); // L∆∞u group ƒë√£ c·∫≠p nh·∫≠t v√†o DB
                    renderCards(); // C·∫≠p nh·∫≠t UI
                    initGroups(); // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng th·∫ª
                } catch (error) {
                    alert("L·ªói khi x√≥a th·∫ª.");
                    console.error("L·ªói deleteCard:", error);
                    // Ho√†n t√°c: Th√™m th·∫ª l·∫°i v√†o m·∫£ng n·∫øu l∆∞u DB l·ªói
                    currentGroup.cards.splice(index, 0, removedCard);
                    renderCards();
                    initGroups();
                }
            }
        }

        async function initializeApp() {
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('theme-switch').checked = true;
            } else {
                document.body.classList.remove('dark-mode');
            }

            quizCheckButton = document.getElementById('quiz-check-btn');
            quizPauseButton = document.getElementById('quiz-pause-btn');
            quizAnswerInput = document.getElementById('quiz-answer'); // G√°n gi√° tr·ªã ·ªü ƒë√¢y
            quizFeedback = document.getElementById('quiz-feedback');
            quizScoreDisplay = document.getElementById('quiz-score');
            quizQuestionDisplay = document.getElementById('quiz-question');
            const questionInput = document.getElementById('question'); // L·∫•y tham chi·∫øu lu√¥n ·ªü ƒë√¢y
            const answerInput = document.getElementById('answer');     // L·∫•y tham chi·∫øu lu√¥n ·ªü ƒë√¢y

            try {
                await openDB();
        
                // --- B∆Ø·ªöC CHUY·ªÇN ƒê·ªîI (Migration) - Ch·ªâ ch·∫°y m·ªôt l·∫ßn ---
                const migrationDone = localStorage.getItem('indexedDB_migration_complete');
                if (!migrationDone) {
                    console.log("Ki·ªÉm tra d·ªØ li·ªáu localStorage c≈© ƒë·ªÉ chuy·ªÉn ƒë·ªïi...");
                    const oldLocalStorageData = localStorage.getItem('groups');
                    if (oldLocalStorageData) {
                        try {
                            const oldGroups = JSON.parse(oldLocalStorageData);
                            if (Array.isArray(oldGroups) && oldGroups.length > 0) {
                                console.log(`T√¨m th·∫•y ${oldGroups.length} nh√≥m c≈© trong localStorage. B·∫Øt ƒë·∫ßu chuy·ªÉn ƒë·ªïi...`);
                                // Ki·ªÉm tra xem DB c√≥ tr·ªëng kh√¥ng tr∆∞·ªõc khi ghi ƒë√®
                                const currentDBGroups = await getAllGroupsDB();
                                if (currentDBGroups.length === 0) {
                                     // Ch·ªâ chuy·ªÉn ƒë·ªïi n·∫øu DB tr·ªëng ƒë·ªÉ tr√°nh ghi ƒë√® d·ªØ li·ªáu m·ªõi h∆°n
                                    for (const group of oldGroups) {
                                        // ƒê·∫£m b·∫£o group c√≥ ID h·ª£p l·ªá (localStorage c≈© c√≥ th·ªÉ kh√¥ng c√≥)
                                        if (!group.id) {
                                            group.id = Date.now().toString() + Math.random().toString(36).substring(2, 9); // T·∫°o ID n·∫øu thi·∫øu
                                            console.warn(`Nh√≥m "${group.name}" thi·∫øu ID, ƒë√£ t·∫°o ID m·ªõi: ${group.id}`);
                                        }
                                        // ƒê·∫£m b·∫£o cards l√† m·∫£ng
                                        if (!Array.isArray(group.cards)) {
                                            group.cards = [];
                                        }
                                        await saveGroupDB(group);
                                    }
                                    console.log("Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu t·ª´ localStorage sang IndexedDB th√†nh c√¥ng!");
                                    // ƒê√°nh d·∫•u ƒë√£ ho√†n th√†nh chuy·ªÉn ƒë·ªïi
                                    localStorage.setItem('indexedDB_migration_complete', 'true');
                                    // Kh√¥ng x√≥a localStorage ngay, ƒë·ªÉ ph√≤ng tr∆∞·ªùng h·ª£p c·∫ßn ki·ªÉm tra l·∫°i
                                    // localStorage.removeItem('groups');
                                } else {
                                     console.log("IndexedDB ƒë√£ c√≥ d·ªØ li·ªáu, b·ªè qua chuy·ªÉn ƒë·ªïi t·ª´ localStorage.");
                                     localStorage.setItem('indexedDB_migration_complete', 'true'); // ƒê√°nh d·∫•u ƒë√£ ki·ªÉm tra
                                }
                            } else {
                                 console.log("Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá trong localStorage c≈© ho·∫∑c m·∫£ng r·ªóng.");
                                 localStorage.setItem('indexedDB_migration_complete', 'true'); // ƒê√°nh d·∫•u ƒë√£ ki·ªÉm tra
                            }
                        } catch (parseError) {
                            console.error("L·ªói khi ƒë·ªçc ho·∫∑c chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu localStorage c≈©:", parseError);
                             // V·∫´n ƒë√°nh d·∫•u ƒë·ªÉ kh√¥ng th·ª≠ l·∫°i li√™n t·ª•c n·∫øu d·ªØ li·ªáu l·ªói
                             localStorage.setItem('indexedDB_migration_complete', 'true');
                        }
                    } else {
                         console.log("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu 'groups' trong localStorage c≈©.");
                         localStorage.setItem('indexedDB_migration_complete', 'true'); // ƒê√°nh d·∫•u ƒë√£ ki·ªÉm tra
                    }
                }
                // --- K·∫æT TH√öC B∆Ø·ªöC CHUY·ªÇN ƒê·ªîI ---
        
        
                // Load d·ªØ li·ªáu nh√≥m t·ª´ IndexedDB (b√¢y gi·ªù c√≥ th·ªÉ ch·ª©a d·ªØ li·ªáu ƒë√£ chuy·ªÉn ƒë·ªïi)
                groups = await getAllGroupsDB();
                console.log('>>> D·ªØ li·ªáu nh√≥m ƒë∆∞·ª£c g√°n v√†o bi·∫øn groups:', JSON.stringify(groups)); // Log quan tr·ªçng!

                if (groups.length === 0) {
                    console.log("Kh√¥ng c√≥ nh√≥m n√†o trong DB, t·∫°o nh√≥m m·∫∑c ƒë·ªãnh.");
                    const defaultGroup = { id: 'default', name: 'M·∫∑c ƒë·ªãnh', cards: [] };
                    await saveGroupDB(defaultGroup); // L∆∞u nh√≥m m·∫∑c ƒë·ªãnh v√†o DB
                    groups.push(defaultGroup); // Th√™m v√†o m·∫£ng hi·ªán t·∫°i
                }

                initGroups();
                renderCards();
                checkPausedQuiz()

                // --- Event Listeners ---
        // Th√™m th·∫ª khi nh·∫•n Enter ·ªü √¥ c√¢u tr·∫£ l·ªùi (ph·∫ßn th√™m th·∫ª)
        document.getElementById('answer').addEventListener('keypress', function(e) {
        });

        // --- Ch·∫°y kh·ªüi t·∫°o khi trang t·∫£i xong ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        answerInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addCard();
            }
        });

        // X·ª≠ l√Ω Enter trong √¥ tr·∫£ l·ªùi quiz
        quizAnswerInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // NgƒÉn submit form (n·∫øu c√≥)
                // K√≠ch ho·∫°t h√†nh ƒë·ªông hi·ªán t·∫°i c·ªßa n√∫t Ki·ªÉm tra/Ti·∫øp theo/Th·ª≠ l·∫°i
                if (quizCheckButton && !quizAnswerInput.disabled) { // Ch·ªâ k√≠ch ho·∫°t n·∫øu input ƒëang b·∫≠t
                    quizCheckButton.click();
                }
            }
        });

        // Tab navigation
        questionInput.addEventListener('keydown', function(e) {
            if (e.key === 'Tab' && !e.shiftKey) {
                e.preventDefault();
                answerInput.focus();
            }
        });
        // Listener th·ª© hai cho 'answer' (xem l·∫°i c√≥ c·∫ßn kh√¥ng)
        answerInput.addEventListener('keydown', function(e) {
             if (e.key === 'Tab') {
                 e.preventDefault();
                 if (e.shiftKey) {
                      questionInput.focus();
                 } else {
                     document.querySelector('.add-card button').focus();
                 }
             }
         });
        // --- K·∫æT TH√öC DI CHUY·ªÇN EVENT LISTENERS ---
    } catch (error) {
        console.error("L·ªói kh·ªüi t·∫°o ·ª©ng d·ª•ng v·ªõi IndexedDB:", error);
        alert("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu nh√≥m. Vui l√≤ng th·ª≠ t·∫£i l·∫°i trang.");
        // C√≥ th·ªÉ hi·ªÉn th·ªã th√¥ng b√°o l·ªói tr√™n UI
    }
}  
document.addEventListener('DOMContentLoaded', initializeApp); // Listener n√†y gi·ªØ nguy√™n
    </script>
</body>
</html>
